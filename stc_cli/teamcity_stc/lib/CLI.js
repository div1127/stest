"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _set=require("babel-runtime/core-js/set"),_set2=_interopRequireDefault(_set),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),fs=require("fs"),path=require("path"),properties=require("properties"),Observable=require("orion-core/lib/Observable"),xfs=require("orion-core/lib/xfs"),logger=require("orion-core/lib/Logger").getInstance(),CLI=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a,b,c=this;c._loadProperties(),a=c._yargs=require("yargs").usage("Usage: stc [command]").option("debug",{type:"boolean"}).option("trace",{type:"boolean"}).command("run","run test scenario").command("server","start archive server").demand(1,"must provide a valid command").epilog("Copyright Sencha "+c._year),b=c._argv=a.argv,c._command=b._[0],c._boundCommands=new _set2["default"],b.debug?logger.setLevel("DEBUG"):b.trace&&logger.setLevel("TRACE")}},{key:"_loadProperties",value:function(){var a,b,c=this,d=global.dirname+"/version.properties",e=global.dirname+"/../Studio/version.properties";xfs.existsSync(d)?a=fs.readFileSync(d,"utf8"):xfs.existsSync(e)&&(a=fs.readFileSync(e,"utf8")),a&&(b=properties.parse(a),c._version=b["app.version"],c._year=b["app.build.date"].split("-")[0])}},{key:"execute",value:function(){var a=this,b=a._command;logger.print(("Sencha Test v"+a._version).bold),process.exitCode=1,a._boundCommands.has(b)?a[b]():(a._yargs.showHelp(),process.exit(1))}},{key:"bind",value:function(a,b){var c=this;c._boundCommands.add(a),c.on(a,function(a){var c=require(xfs.join(global.dirname,b)),d=new c(a);d.execute()})}},{key:"run",value:function(){var a=this._yargs.reset().usage("$0 run [-o output] [-p pool] [-s scenario]").option("o",{alias:"output","default":"text",describe:"Output format",choices:["text","junit","teamcity"],type:"string"}).option("p",{alias:"pool",describe:"Browser pool name",type:"string"}).option("s",{alias:"scenario",describe:"Path to test scenario",type:"string"}).option("scenarioName",{describe:"Scenario name",type:"string"}).option("u",{alias:"user",describe:"Username for the browser farm *",type:"string"}).option("k",{alias:"key",describe:"Access key for the browser farm *",type:"string"}).option("c",{alias:"callbackAddress",describe:"Address through which browsers can connect to the local machine, if other than localhost",type:"string"}).option("x",{alias:"proxyPort",describe:"Port number for the In-Browser proxy",type:"string"}).option("S",{alias:"archiveServer",describe:"Archive server address",type:"string"}).option("K",{alias:"storageKey",describe:"Key to the storage area",type:"string"}).option("O",{alias:"overwrite",describe:"Overwrite existing results in the archive server for the specified build number",type:"boolean"}).option("integrationPush",{describe:"Push all failures to issue tracking service",type:"boolean"}).option("integrationProject",{demand:!1,describe:"The project that will receive issues in the tracking service",type:"string"}).option("integrationPassword",{describe:"Password to use to connect to issue tracking service",type:"string"}).option("n",{alias:"buildnumber",describe:"Build number",type:"string"}).option("b",{alias:"baseline",describe:"Path to the baseline dir",type:"string"}).option("C",{alias:"coverage",describe:"Enable code coverage",type:"boolean"}).option("a",{alias:"archivedir",describe:"Path where report files and result archives are stored",type:"string"}).option("t",{alias:"timeout",describe:"Browser communication timeout (ms)",type:"string"}).option("cmd",{describe:"Sencha Cmd path",type:"string"}).options("capability",{describe:"Add or override Selenium desired capabilities (key=value)",type:"string"}).epilogue("* SauceLabs and BrowserStack only").help("h").alias("h","help").argv;this.fire({type:"run",output:a.o,poolName:a.p,scenarioDir:a.s?path.resolve(a.s):process.cwd(),scenarioName:a.scenarioName,username:a.u,accessKey:a.k,callbackAddress:a.callbackAddress,proxyPort:a.proxyPort,autoStartTunnel:a.notunnel!==!0,archiveServer:a.S,storageKey:a.K,overwrite:a.O,pushFailures:a.integrationPush,project:a.integrationProject,servicePassword:a.integrationPassword,buildNumber:a.n,baselinedir:a.b,coverage:a.coverage,workdir:a.archivedir,timeout:a.timeout,cmdPath:a.cmd?path.resolve(a.cmd):null,capabilities:a.capability,argv:a})}},{key:"server",value:function(){var a=this._yargs.reset().usage("$0 server").option("s",{alias:"storage",describe:"The path to the storage.json file",type:"string"}).option("p",{alias:"port",describe:"Server port",type:"string"}).argv;this.fire({type:"server",storageRoot:a.storage,port:a.port,argv:a})}},{key:"integration",value:function(){var a=this._yargs.reset().usage("$ integration -t type -c protocol -h host -r port -n username [-p project] -S archiveServer [-d]").option("t",{alias:"type",demand:!0,"default":"jira",describe:"The type of service",choices:["jira"],type:"string"}).option("c",{alias:"protocol",demand:!0,"default":"https",describe:"Protocol for connecting to the service",type:"string"}).option("o",{alias:"host",demand:!0,describe:"Hostname for connecting to the service",type:"string"}).option("r",{alias:"port",describe:"Port for connecting to the service",type:"string"}).option("u",{alias:"username",demand:!0,describe:"The username for connecting to the service",type:"string"}).option("p",{alias:"project",demand:!1,describe:"The project that will receive issues in the tracking service",type:"string"}).option("S",{alias:"archiveServer",demand:!0,describe:"Archive server address",type:"string"}).option("d",{alias:"delete",demand:!1,describe:"Delete the service credentials",type:"boolean"}).help("h").alias("h","help").argv;this.fire({type:"integration",almType:a.type,protocol:a.protocol,host:a.host,port:a.port,username:a.username,project:a.project,server:a.archiveServer,argv:a})}},{key:"upload",value:function(){var a=this._yargs.reset().usage("$0 upload -s server -a archive").option("S",{alias:"server",demand:!0,describe:"Server address",type:"string"}).option("a",{alias:"archive",demand:!0,describe:"Archive",type:"string"}).option("p",{alias:"archivePath",describe:"Archive path within the storage area",type:"string"}).option("K",{alias:"key",demand:!0,describe:"Key to the storage area",type:"string"}).help("h").alias("h","help").argv;this.fire({type:"upload",server:a.S,archive:a.a,archivePath:a.p,storageKey:a.K,argv:a})}},{key:"download",value:function(){var a=this._yargs.reset().usage("$0 upload -s server -p path").option("s",{alias:"server",demand:!0,describe:"Server Address",type:"string"}).option("r",{alias:"root",describe:'Server Archive Root (required if no "key" is specified)',type:"string"}).option("k",{alias:"key",describe:"Key to the storage area",type:"string"}).option("p",{alias:"path",demand:!0,describe:"Server Path",type:"string"}).option("l",{alias:"localPath",demand:!0,describe:"Local Path",type:"string"}).help("h").alias("h","help").argv;a.k||a.r||(this._yargs.showHelp(),process.exit(1)),this.fire({type:"download",server:a.s,root:a.r,storageKey:a.k,path:a.p,localPath:a.l,argv:a})}},{key:"merge",value:function(){var a=this._yargs.reset().usage("$0 merge archive1 archive2").demand(2).help("h").alias("h","help").argv;this.fire({type:"merge",archive1:a._[1],archive2:a._[2],argv:a})}}]),b}(Observable);module.exports=new CLI;
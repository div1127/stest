"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}function doRequest(a){return rp(a).then(function(a){return a.success===!1?_promise2["default"].reject(a.message||a):a})["catch"](function(a){throw logger.debug(a.stack||a),a})}var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),Base=require("orion-core/lib/Base"),Zip=require("orion-core/lib/fs/Zip"),xfs=require("orion-core/lib/xfs"),Metarun=require("./Metarun"),co=require("co"),fs=require("fs"),rp=require("request-promise"),url=require("url"),util=require("util"),path=require("path"),logger=require("orion-core/lib/Logger").getInstance().forClass("archive/Client"),Client=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"saveConnection",value:function(a){logger.trace(".saveConnection");var b=this,c=b._validateUrl("/save-alm-connection"),d=void 0;return"object"===("undefined"==typeof c?"undefined":(0,_typeof3["default"])(c))?c:(d={method:"POST",uri:c,body:a,json:!0,encoding:null,resolveWithFullResponse:!0},doRequest(d).then(function(a){return util.format("Server response: %s - %s",a.statusCode,a.body||a.statusMessage)}))}},{key:"getConnection",value:function(){logger.trace(".getConnection");var a=this,b=a._validateUrl("/get-alm-connection"),c=void 0;return"object"===("undefined"==typeof b?"undefined":(0,_typeof3["default"])(b))?b:(c={method:"GET",uri:b,json:!0,encoding:null,resolveWithFullResponse:!0},doRequest(c).then(function(a){return a.body}))}},{key:"validateStorageKey",value:function(a){logger.trace(".validateStorageKey");var b=this,c=b._validateUrl("/validate-storage-key"),d=void 0;return"object"===("undefined"==typeof c?"undefined":(0,_typeof3["default"])(c))?c:(d={method:"POST",uri:c,body:a,json:!0,encoding:null,resolveWithFullResponse:!0},doRequest(d).then(function(a){return a.body}))}},{key:"getArchiveRoot",value:function(a){logger.trace(".getArchiveRoot");var b=this,c=b._validateUrl("/get-archive-root?storageKey="+a),d=void 0;return"object"===("undefined"==typeof c?"undefined":(0,_typeof3["default"])(c))?c:(d={method:"GET",uri:c,json:!0,encoding:null,resolveWithFullResponse:!0},doRequest(d).then(function(a){return a.body}))}},{key:"upload",value:function(a,b){var c=this,d={method:"POST",uri:url.resolve(c.server,"/upload"),formData:{archiveId:b.archiveId,buildNumber:b.buildNumber,storageKey:b.storageKey||c.storageKey,archivePath:b.archivePath||"",archive:fs.createReadStream(a),overwrite:b.overwrite?"true":"false"},resolveWithFullResponse:!0};return doRequest(d).then(function(a){return util.format("Server response: %s - %s",a.statusCode,a.body||a.statusMessage)})}},{key:"download",value:function(a){var b=this,c=path.normalize(a.localPath),d=path.dirname(c),e={method:"POST",uri:url.resolve(b.server,"/download"),body:{root:a.root,storageKey:a.storageKey||b.storageKey,path:a.path},json:!0,encoding:null,resolveWithFullResponse:!0,simple:!1},f=xfs.mkdir(d).then(function(a){return doRequest(e)}).then(function(a){return 200===a.statusCode?xfs.writeFile(c+".zip",a.body):404===a.statusCode?_promise2["default"].resolve():(logger.error(a),_promise2["default"].reject(a))}).then(function(a){if(a&&a.$isFile)return Zip.extract(c+".zip",path.dirname(c))});return f}},{key:"getMetarun",value:function(a){logger.trace(".getMetarun");var b,c=this,d=c._validateUrl("/get-metarun");return"object"===("undefined"==typeof d?"undefined":(0,_typeof3["default"])(d))?d:(b={method:"POST",uri:d,body:{root:a.root,path:a.path},json:!0,encoding:null,resolveWithFullResponse:!0},doRequest(b).then(function(b){var d=b.body;return d.success?new Metarun({archiveClient:c,data:d.metarun,type:a.type}):(logger.error(d.message),_promise2["default"].reject(d.message))}))}},{key:"saveMetarun",value:function(a){var b,c=this,d=c._validateUrl("/save-metarun");return"object"===("undefined"==typeof d?"undefined":(0,_typeof3["default"])(d))?_promise2["default"].reject():(b={method:"POST",uri:d,body:{storageKey:a.storageKey||c.storageKey,path:a.path,metarun:a.metarun.data},json:!0,encoding:null,resolveWithFullResponse:!0},doRequest(b).then(function(a){var b=a.body;if(!b.success)return logger.error(b.message),_promise2["default"].reject(b.message)}))}},{key:"_validateUrl",value:function(a){var b=this,c=void 0;try{return c=url.resolve(b.server,a)}catch(d){return _promise2["default"].reject("Please provide a valid address to a connected archive server")}}}]),b}(Base);module.exports=Client;
"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),bodyParser=require("body-parser"),co=require("co"),compress=require("compression"),express=require("express"),fs=require("fs"),multer=require("multer"),path=require("path"),recursive=require("recursive-readdir"),Url=require("url"),uuid=require("uuid"),File=require("../fs/File"),Json=require("../Json"),Merger=require("./Merger"),Observable=require("../Observable"),xfs=require("../xfs"),Zip=require("../fs/Zip"),logger=require("../Logger").getInstance().forClass("archive/Server"),serverDir=process.cwd(),storageRoot=xfs.join(serverDir,"storage"),PORT=1903,Catalog=function(){function a(b){(0,_classCallCheck3["default"])(this,a),this.file=b.$isFile?b:new File(b),this.path=this.file.getPath(),this.file.existsSync()?this.data=this.file.readJsonSync():this.data={}}return(0,_createClass3["default"])(a,[{key:"save",value:function(){var a=this,b=a.file,c=new File(b.parent,uuid.v1());return c.writeJson(this.data,{prettyPrint:!0}).then(function(){return xfs.rename(c.path,b.path)})}}],[{key:"getCatalog",value:function(b){var c=a.map||(a.map={}),d=b.$isFile?b.getPath():b,e=c[d];return e||(e=new a(b),c[d]=e),e}}]),a}(),ArchiveServer=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a,b,c,d=this,e=864e5,f=d.app=express();d.port=d.port||PORT,d._operationQueue=_promise2["default"].resolve(),d.storageRoot&&(serverDir=new File(d.storageRoot).getCanonicalFile().getParent(),storageRoot=xfs.join(serverDir,"storage")),d.getStorage(),d._getALMConnection(),d._initCatalogs(),a=d._getDiskStorage(),b=d._getMulter(a),c=bodyParser.json(),f.get("/get-alm-connection",c,d._queueRetrieveALMConnection.bind(d)),f.get("/get-archive-root",c,d._queueRetrieveArchiveRoot.bind(d)),f.post("/upload",b,d._queueUpload.bind(d)),f.post("/download",c,d._queueDownload.bind(d)),f.post("/update-baseline",c,d._queueUpdateBaseline.bind(d)),f.post("/get-metarun",c,d._queueGetMetarun.bind(d)),f.post("/save-metarun",c,d._queueSaveMetarun.bind(d)),f.post("/validate-storage-key",c,d._queueValidateStorageKey.bind(d)),f.use(express["static"](storageRoot,{maxAge:e})),f.use(compress()),f.listen(d.port,function(){logger.info("Archive server listening on port",d.port)}).on("error",function(a){"EADDRINUSE"===a.code?logger.error("The archive server is already actively running on port"+d.port+". Please use -p parameter to specify a different port."):logger.error("There was a problem starting the archive server:",a.message)})}},{key:"_getDiskStorage",value:function(){var a=this;return multer.diskStorage({destination:function b(c,d,e){var f=a.getStorage(),g=c.body.storageKey,h=c.body.archivePath,b=xfs.join(storageRoot,f[g].path);h&&(b=xfs.join(b,h)),xfs.mkdir(b).then(function(){c.storageDir=new File(b),e(null,b)})},filename:function(a,b,c){var d=uuid.v1();a.stagingKey=d,c(null,d+".zip")}})}},{key:"_getMulter",value:function(a){var b=this;return multer({storage:a,fileFilter:function(a,c,d){var e,f=b.getStorage(),g=a.body.storageKey;return f[g]?(e=c.originalname,e.toLowerCase().endsWith(".zip")?(a.body.archiveId||(a.body.archiveId=path.basename(c.originalname,".zip")),a.body.buildNumber||(a.body.buildNumber=a.body.archiveId),void d(null,!0)):void d("Invalid archive file name: "+e)):void d("Invalid storage key",!1)}}).single("archive")}},{key:"_queueOperation",value:function(a){return this._operationQueue=this._operationQueue.then(a)}},{key:"_queueUpload",value:function(a,b,c){var d=this;return d._queueOperation(function(){return co(d._upload(a,b,c))["catch"](function(c){a._logger.destroy(),logger.error("Error receiving archive"),logger.error(c.stack||c),b.status(500).send("Error processing archive - see server log for more information")})})}},{key:"_upload",value:_regenerator2["default"].mark(function c(a,b,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka;return _regenerator2["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return e=this,f=a.file,g=a.body.archiveId,h=a.body.buildNumber,i=a.storageDir,j=a.stagingKey,k=i.join(j),l=new File(a.file.path),m=i.join("baseline"),n=m+".zip",o=a.body.storageKey,p="true"===a.body.overwrite,q=e.getStorage(),r=q[o],s=r&&r.path,t=r&&r.allowOverwrite,u=!1,v=a._logger=logger.forObject("archive/Server",h),v.info("Receiving archive"),p&&!t&&v.warn("Result overwrite not allowed in storage area ",s),s.startsWith("/")&&(s=s.substring(1)),C=new File(storageRoot).join(s),D=C.join("catalog.json"),E=Catalog.getCatalog(D),F=E.data,G=a.body.archivePath,H=F.archives||(F.archives={}),H[G]=H[G]||{path:File.slashify(File.join(G,"catalog.json"))},c.next=9,E.save();case 9:if(I=Catalog.getCatalog(C.join(G).join("catalog.json")),K=I.data,K.count=K.count||0,J=K.runs||(K.runs={}),w=J[h],!w){c.next=43;break}return v.info("Existing build found"),z=w.path,A=path.basename(z,".zip"),y=i.join(z),x=i.join(A),v.info("Extracting",l.path,"to",k.path),c.next=23,Zip.extract(l.path,k.path);case 23:return M=new Merger({overwrite:p&&t}),N=k.join(g),v.info("Merging results"),c.next=27,M.merge(x,N);case 27:return v.info("Results merged"),B=M.warnings,v.info("Cleaning up temporary files"),c.next=32,k.remove();case 32:return c.next=34,l.remove();case 34:return v.info("Compressing results"),c.next=37,Zip.fromDir(x.path,i.join(A+"_new.zip").path,null,A);case 37:return O=c.sent,v.info("Updating result archive"),c.next=41,xfs.rename(O.fileName,y.path);case 41:c.next=52;break;case 43:return A=g,y=i.join(A+".zip"),x=i.join(A),v.info("Extracting",l.path,"to",x.path),c.next=49,Zip.extract(l.path,i.path);case 49:return v.info("Moving",l.path,"to",y.path),c.next=52,xfs.rename(l.path,y.path);case 52:return v.info("Updating catalogs"),P=(new Date).getTime(),L=J[h]||{id:++K.count,path:A+".zip"},L.uploaded=L.uploaded||P,L.lastUpdated=P,J[h]=L,c.next=60,I.save();case 60:return v.info("Processing screenshots"),c.next=63,function(a){recursive(x.path,["!*.png","*-baseline.png","*-diff.png"],a)};case 63:Q=c.sent,R=Q.length,S=0,Q.length?v.info("Found",Q.length,"screenshots"):v.info("No screenshots found"),T=!0,U=!1,V=void 0,c.prev=69,W=(0,_getIterator3["default"])(Q);case 71:if(T=(X=W.next()).done){c.next=97;break}return f=X.value,Y=m.join(x.relativeTo(f)),c.next=76,xfs.exists(Y);case 76:if(Z=c.sent){c.next=94;break}return c.prev=78,c.next=81,xfs.mkdir(path.dirname(Y.path));case 81:return c.next=83,xfs.copy(f,Y);case 83:if(v.info("Initialized baseline image:",Y),u){c.next=88;break}return c.next=87,xfs.removeFile(n);case 87:u=!0;case 88:c.next=94;break;case 90:c.prev=90,c.t0=c["catch"](78),v.error("Could not copy baseline image:",Y),v.error(c.t0.stack||c.t0);case 94:T=!0,c.next=71;break;case 97:c.next=103;break;case 99:c.prev=99,c.t1=c["catch"](69),U=!0,V=c.t1;case 103:c.prev=103,c.prev=104,!T&&W["return"]&&W["return"]();case 106:if(c.prev=106,!U){c.next=109;break}throw V;case 109:return c.finish(106);case 110:return c.finish(103);case 111:if($=["Archive received"],!B){c.next=135;break}if($[0]=$[0]+" (merged)",!B.length){c.next=135;break}for($.push("WARNINGS:"),_=!0,aa=!1,ba=void 0,c.prev=119,ca=(0,_getIterator3["default"])(B);!(_=(da=ca.next()).done);_=!0)ea=da.value,$.push("    "+ea);c.next=127;break;case 123:c.prev=123,c.t2=c["catch"](119),aa=!0,ba=c.t2;case 127:c.prev=127,c.prev=128,!_&&ca["return"]&&ca["return"]();case 130:if(c.prev=130,!aa){c.next=133;break}throw ba;case 133:return c.finish(130);case 134:return c.finish(127);case 135:for(fa=!0,ga=!1,ha=void 0,c.prev=138,ia=(0,_getIterator3["default"])($);!(fa=(ja=ia.next()).done);fa=!0)ka=ja.value,v.info(ka);c.next=146;break;case 142:c.prev=142,c.t3=c["catch"](138),ga=!0,ha=c.t3;case 146:c.prev=146,c.prev=147,!fa&&ia["return"]&&ia["return"]();case 149:if(c.prev=149,!ga){c.next=152;break}throw ha;case 152:return c.finish(149);case 153:return c.finish(146);case 154:b.status(200).send($.join("\n")),v.destroy();case 156:case"end":return c.stop()}},c,this,[[69,99,103,111],[78,90],[104,,106,110],[119,123,127,135],[128,,130,134],[138,142,146,154],[147,,149,153]])})},{key:"_queueDownload",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._download(a,b))["catch"](function(a){logger.error(a.stack||a),b.status(500).send("Error downloading archive - see server log for more information")})})}},{key:"_download",value:_regenerator2["default"].mark(function d(a,b){var c,e,f,g,h,i,j,k,l,m;return _regenerator2["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(c=this,e=a.body,f=e.storageKey,g=e.root,h=c.getStorage(),g){d.next=7;break}if(f?h[f]?g=h[f].path:i="Invalid storage key":i="Cannot download files without either a root directory or a storage key",!i){d.next=7;break}return logger.error(i.stack||i),b.status(500).send(i),d.abrupt("return");case 7:return j=File.join(storageRoot,g,e.path),k=j+".zip",d.next=11,xfs.exists(j);case 11:if(l=d.sent,!l){d.next=25;break}return d.next=15,xfs.exists(k);case 15:if(m=d.sent){d.next=22;break}return d.next=19,Zip.fromDir(j);case 19:b.download(k),d.next=23;break;case 22:b.download(k);case 23:d.next=26;break;case 25:b.status(404).send("Not found: "+j);case 26:case"end":return d.stop()}},d,this)})},{key:"_queueRetrieveArchiveRoot",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._retrieveArchiveRoot(a,b))["catch"](function(a){logger.error(a.stack||a),b.json({success:!1,message:"Cannot retrieve ALM connection information. "+a})})})}},{key:"_retrieveArchiveRoot",value:_regenerator2["default"].mark(function e(a,b){var c,d,f;return _regenerator2["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:c=this,d=a.query.storageKey,f=c.getStorage(),b.json({archiveRoot:f[d].path});case 2:case"end":return e.stop()}},e,this)})},{key:"_queueRetrieveALMConnection",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._retrieveALMConnection(a,b))["catch"](function(a){logger.error(a.stack||a),b.json({success:!1,message:"Cannot retrieve ALM connection information. "+a})})})}},{key:"_retrieveALMConnection",value:_regenerator2["default"].mark(function f(a,b){var c;return _regenerator2["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:c=this,b.json(c._getALMConnection());case 2:case"end":return a.stop()}},f,this)})},{key:"_queueSaveALMConnection",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._saveALMConnection(a,b))["catch"](function(a){logger.error(a.stack||a),b.json({success:!1,message:"Cannot save ALM connection information. "+a})})})}},{key:"_saveALMConnection",value:_regenerator2["default"].mark(function g(a,b){var c,d,e,f,h,i,j,k,l,m,n;return _regenerator2["default"].wrap(function(g){for(;;)switch(g.prev=g.next){case 0:c=this,d=a.body,e=d.protocol,f=d.host,h=d.port,i=d.username,j=d.project,k=d.type,l=d.shouldDelete,m=xfs.join(serverDir,"alm.json"),n={protocol:e,host:f,port:h,username:i,project:j,type:k},l?(logger.info("Removing ALM connection details from "+m),fs.unlinkSync(m)):(logger.info("Writing ALM connection details to "+m),logger.debug("Connection Details: "+(0,_stringify2["default"])(n,null,4)),fs.writeFileSync(m,(0,_stringify2["default"])(n,null,4))),b.json({success:!0});case 3:case"end":return g.stop()}},g,this)})},{key:"_queueUpdateBaseline",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._updateBaseline(a,b))["catch"](function(a){logger.error(a.stack||a),b.json({success:!1,message:"Cannot update baseline image. "+a})})})}},{key:"_updateBaseline",value:_regenerator2["default"].mark(function h(a,b){var c,d,e,f,g,i,j,k,l,m,n,o;return _regenerator2["default"].wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(c=this,d=a.body,e=d.storageKey,f=d.screenshot,g=d.archiveId,i=d.archivePath,j=c.getStorage(),j[e]){h.next=6;break}return b.json({success:!1,message:"Invalid storage key"}),h.abrupt("return");case 6:o=j[e].path;case 7:return n=File.join(storageRoot,o,i),k=File.join(n,"baseline"),m=File.join(n,g,f),l=File.join(k,f),l=l.replace(/-baseline.png$/,".png"),h.next=14,xfs.exists(m);case 14:if(!h.sent){h.next=22;break}return h.next=17,xfs.copy(m,l);case 17:return h.next=19,xfs.removeFile(k+".zip");case 19:b.json({success:!0}),h.next=23;break;case 22:b.json({success:!1,message:"Cannot update baseline image.  Actual does not exist: "+m});case 23:case"end":return h.stop()}},h,this)})},{key:"_queueGetMetarun",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._getMetarun(a,b))["catch"](function(a){logger.error(a.stack||a),b.json({success:!1,message:"Cannot get metarun information. "+a})})})}},{key:"_getMetarun",value:_regenerator2["default"].mark(function i(a,b){var c,d,e,f,g,h;return _regenerator2["default"].wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return c=this,d=a.body,e=xfs.join(storageRoot,d.root,d.path,"meta.json"),f=new File(e),i.next=5,f.exists();case 5:if(h=i.sent,logger.debug("Getting metarun from",e),!h){i.next=13;break}return i.next=10,f.readJson();case 10:g=i.sent,i.next=14;break;case 13:g={};case 14:b.json({success:!0,metarun:g});case 15:case"end":return i.stop()}},i,this)})},{key:"_queueSaveMetarun",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._saveMetarun(a,b))["catch"](function(a){logger.error(a.stack||a),b.json({success:!1,message:"Cannot save metarun information. "+a})})})}},{key:"_saveMetarun",value:_regenerator2["default"].mark(function j(a,b){var c,d,e,f,g,h,i,k;return _regenerator2["default"].wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(c=this,d=a.body,e=c.getStorage(),f=e[a.body.storageKey],g=a.body.metarun,f){j.next=4;break}return b.json({success:!1,message:"Invalid storage key"}),j.abrupt("return");case 4:return h=f.path,k=xfs.join(storageRoot,h,d.path,"meta.json.tmp"),i=xfs.join(storageRoot,h,d.path,"meta.json"),j.next=9,Json.write(k,g);case 9:return j.next=11,xfs.rename(k,i);case 11:b.json({success:!0});case 12:case"end":return j.stop()}},j,this)})},{key:"_queueValidateStorageKey",value:function(a,b){var c=this;return c._queueOperation(function(){return co(c._validateStorageKey(a,b))["catch"](function(a){logger.error(a.stack||a),b.json({success:!1,message:"Cannot retrieve server details. "+a})})})}},{key:"_validateStorageKey",value:_regenerator2["default"].mark(function k(a,b){var c,d,e,f,g,h;return _regenerator2["default"].wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(c=this,d=a.body,e=d.archiveRoot,f=d.storageKey,g=c.getStorage(),e){i.next=4;break}return b.json({success:!1,message:"Invalid Archive Root specified"}),i.abrupt("return");case 4:h=g[f],b.json({success:h&&h.path===e});case 6:case"end":return i.stop()}},k,this)})},{key:"_initCatalogs",value:function(){var a=this.getStorage(),b=(0,_keys2["default"])(a);b.forEach(function(b){var c,d,e=a[b].path;e.startsWith("/")&&(e=e.substring(1)),c=new File(storageRoot).join(e).join("catalog.json"),d=Catalog.getCatalog(c),d.save()})}},{key:"_getALMConnection",value:function(){var a=this;if(!a._almConnection){var b,c;try{b=xfs.join(serverDir,"alm.json"),c=fs.readFileSync(b);try{a._almConnection=JSON.parse(c)}catch(d){logger.error("Error parsing "+b),logger.error(d.stack||d),a.fire({type:"fatalError",error:d})}}catch(d){logger.debug("No ALM connection config found at: "+b)}}return a._almConnection}},{key:"getStorage",value:function(){var a=this;if(!a.storage){var b,c;try{b=xfs.join(serverDir,"storage.json"),c=fs.readFileSync(b)}catch(d){logger.error("Error loading storage config from "+b),a.fire({type:"fatalError",error:d})}try{a.storage=JSON.parse(c)}catch(d){logger.error("Error parsing "+b),logger.error(d.stack||d),a.fire({type:"fatalError",error:d})}}return a.storage}},{key:"setStorage",value:function(a){this.storage=a,this._initCatalogs()}},{key:"stop",value:function(){var a=this.app;a&&a.close()}},{key:"dtor",value:function(){this.stop()}}]),b}(Observable);module.exports=ArchiveServer;
"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),child_process=require("child_process"),path=require("path"),scriptName="shell-wrapper.sh",xfs=require("../xfs"),homeDir=xfs.homeDir,File=require("../fs/File"),Util=require("../Util"),dir=new File(__dirname),platform={isLinux:/^linux/.test(process.platform),isMac:/^darwin/.test(process.platform),isWin:/^win/.test(process.platform)},fs=require("fs"),pidFormat=/^\d+$/,wrapper=new File(dir,scriptName),_execInfo,ProcessUtil=function(){function a(){(0,_classCallCheck3["default"])(this,a)}return(0,_createClass3["default"])(a,[{key:"_getCfg",value:function(a,b,c){return platform.isWin?this._getWinCfg(a,b,c):this._getUnixCfg(a,b,c)}},{key:"_getWinCfg",value:function(a,b,c){b=b||[],b.unshift("/C",a),a="cmd.exe";var d={encoding:"utf8"};return(0,_assign2["default"])(d,c),{executable:a,args:b,options:d}}},{key:"_getUnixCfg",value:function(a,b,c){b=b||[],b.unshift("-l",wrapper.getCanonicalPath(),a),a="/bin/bash";var d={encoding:"utf8"};return(0,_assign2["default"])(d,c),{executable:a,args:b,options:d}}},{key:"spawn",value:function(a,b,c){if("string"==typeof a&&(a=this._getCfg(a,b,c)),a.options&&a.options.cwd){var d=new File(a.options.cwd);d.ensurePathExistsSync()}return child_process.spawn(a.executable,a.args,a.options)}},{key:"spawnSync",value:function(a,b,c){if("string"==typeof a&&(a=this._getCfg(a,b,c)),a.options&&a.options.cwd){var d=new File(a.options.cwd);d.ensurePathExistsSync()}return child_process.spawnSync(a.executable,a.args,a.options)}},{key:"exec",value:function(a,b,c){if(b&&b.cwd){var d=new File(b.cwd);d.ensurePathExistsSync()}return child_process.exec(a,b,c)}},{key:"_winKill",value:function(a){var b=this.spawnSync({executable:"taskkill",args:["/PID",a,"/F","/T"],options:{encoding:"utf8"}});return b.error&&console.error(b.error.stack||b.error),0===b.status&&!b.error}},{key:"_unixKill",value:function(a){var b,c,d=this,e=child_process.spawnSync("pgrep",["-P",a],{encoding:"utf8"});return 0===e.status?(b=e.stdout.split("\n"),b.forEach(function(a){a=a&&a.trim(),a&&pidFormat.test(a)&&(c=parseInt(a),d._unixKill(c))})):e.error&&console.error(e.error.stack||e.error),e=child_process.spawnSync("kill",["-9",a],{encoding:"utf8"}),e.error&&console.error(e.error.stack||e.error),0===e.status&&!e.error}},{key:"kill",value:function(a){return platform.isWin?this._winKill(a):this._unixKill(a)}},{key:"execInfo",get:function(){if(_execInfo)return _execInfo;var a,b,c,d,e=process.execPath,f=[],g=!1;if(e.endsWith("Sencha Studio.exe")||e.endsWith("Sencha Studio Helper")||e.endsWith("Launcher")?(a=!1,b=!0,g=!0):e.endsWith("electron.exe")||e.endsWith("Electron Helper")||e.endsWith("electron")||e.endsWith("Electron")?(a=!1,b=!1):e.endsWith("node.exe")||e.endsWith("node")||e.endsWith("nodejs")?(a=!0,b=null):(a=!1,b=!0),a&&(c=path.join(process.mainModule.filename,".."),d=path.join(c,".."),Util.isMac?xfs.existsSync(path.join(c,"Electron.app"))?(e=path.join(c,"Electron.app","Contents","MacOS","Electron"),b=!0):xfs.existsSync(path.join(d,"Sencha Studio.app"))&&(e=path.join(d,"Sencha Studio.app","Contents","MacOS","Sencha Studio"),b=!0,g=!0):Util.isWin?xfs.existsSync(path.join(c,"electron.exe"))?(e=path.join(c,"electron.exe"),b=!0):xfs.existsSync(path.join(d,"Sencha Studio.exe"))&&(e=path.join(d,"Sencha Studio.exe"),b=!0,g=!0):Util.isLinux&&(xfs.existsSync(path.join(c,"electron"))?(e=path.join(c,"electron"),b=!0):xfs.existsSync(path.join(d,"Launcher"))&&(e=path.join(d,"Launcher"),b=!0,g=!0)),b||(e=require("electron"))),!a&&Util.isMac)if(b){var h="/Frameworks/Sencha Studio Helper.app/Contents/MacOS/Sencha Studio Helper",i="/MacOS/Sencha Studio";e=e.replace(h,i)}else{var j="/Frameworks/Electron Helper.app/Contents/MacOS/Electron Helper",k="/MacOS/Electron";e=e.replace(j,k)}if(Util.isWin&&(e=xfs.normalize(e)),!g){var l=void 0;l=a?path.join(process.mainModule.filename):path.join(process.mainModule.filename,"..","studio.js"),Util.isWin&&(l=xfs.normalize(l)),f.push(l)}return _execInfo={isCommandline:a,isProduction:b,spawnExecutable:e,hasStudio:g,stcDir:c,orionDir:d,baseCommandLineParams:f}}}]),a}();if(wrapper.path.indexOf("app.asar")>0&&(platform.isMac||platform.isLinux))try{var data=wrapper.readSync(),currentData;wrapper=homeDir.join("bin/sencha").join(scriptName),wrapper.getStat().then(function(a){var b,c,d=!0;a&&(currentData=wrapper.readSync(),b=a.birthtime.getTime(),c=a.mtime.getTime(),c-b>6e4?d=!1:data==currentData&&(d=!1)),d&&(a&&wrapper.removeSync(),wrapper.writeSync(data))})}catch(err){console.error(err.stack||err)}module.exports=new ProcessUtil;
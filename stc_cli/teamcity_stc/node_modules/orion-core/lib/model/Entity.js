"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Base=require("../Base"),Json=require("orion-core/lib/Json"),xfs=require("../xfs.js"),Util=require("../Util"),fs=require("fs"),Path=require("path"),Entity=function(a){function b(a){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).call(this,{data:a||{}}))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"clone",value:function(){var a=this.constructor,b=new a(Util.clone(this.data));return b.setSourceFile(this.sourceFile),b}},{key:"copyFrom",value:function(a,b){"string"==typeof b&&(b=b.split(","));var c,d,e,f,g,h;for(h=b.length;h-- >0;)d=e=b[h],c=d.endsWith("?"),c&&(d=e=d.substring(0,d.length-1)),(f=d.indexOf("->"))>0?(d=d.substring(0,f),e=e.substring(f+2)):(f=d.indexOf("<-"))>0&&(e=e.substring(0,f),d=d.substring(f+2)),d in a&&(g=a[d],!c||null!==g&&""!==g||(g=void 0),this.set(e,g));return this}},{key:"get",value:function(a){var b,c,d=this.data;if("string"==typeof a)c=d[a];else for(c={},Array.isArray(a)||(a=(0,_keys2["default"])(a)),b=a.length;b-- >0;)c[a[b]]=this.get([a[b]]);return c}},{key:"getId",value:function(){return this.data.id}},{key:"getName",value:function(){return this.name||this.data.name||this.relativePath||this.baseName||""}},{key:"setName",value:function(a){this.set("name",a)}},{key:"setOwner",value:function(a){this.owner=a}},{key:"getPersistData",value:function(){return this.data}},{key:"getWorkspace",value:function(){return this.isWorkspace?this:this.workspace?this.workspace:this.owner?this.owner.getWorkspace():null}},{key:"loadChildren",value:function(){return _promise2["default"].resolve(this)}},{key:"resolve",value:function(){var a=Array.prototype.slice.call(arguments,0),b=a.length&&a[0];return b&&(a[0]=this.resolveVariables(b)),a.unshift(this.dir),Path.resolve.apply(Path,a)}},{key:"resolveVariables",value:function(a){var b=this.owner;return b?b.resolveVariables(a):a}},{key:"save",value:function(){var a,b,c=this;if(c.error)throw new Error("Cannot save this entity");return a=c.getPersistData(),b=(0,_stringify2["default"])(a,null,4)+"\n",xfs.writeFile(c.sourceFile,b).then(function(){return c})}},{key:"set",value:function(a,b){var c=this,d=c.data,e=null;if("string"==typeof a)e=d[a],void 0===b?delete d[a]:(d[a]=b,"name"===a&&"name"in c&&(c.name=a));else for(var f in a)c.set(f,a[f]);return e}},{key:"setRelativePath",value:function(a){a=(a||"").replace(/[\\]/g,"/"),"/"===a.charAt(0)&&(a=a.substring(1)),this.relativePath=a}},{key:"setSourceFile",value:function(a){a&&(this.sourceFile=this.path=a,this.dir=Path.resolve(a,".."),this.baseName=Path.basename(this.dir))}}],[{key:"load",value:function(a,b,c){var d=this;return a.$isFile&&(a=a.path),"boolean"==typeof b&&(c=b,b=null),new _promise2["default"](function(e,f){a.endsWith(".json")||(a=Path.join(a,d.jsonName));var g,h=Path.resolve(a,"..");try{var i=fs.readFileSync(a,"utf8");try{g=new d(Json.parse(i)),b&&g.setOwner(b),g.setSourceFile(a),c===!1?e(g):g.loadChildren().then(e,function(a){g.error=a,e(g)})}catch(j){g=new d,b&&g.setOwner(b),g.setSourceFile(a),g.error=j,e(g)}}catch(j){g=new d,b&&g.setOwner(b),g.setSourceFile(a),g.error=new Error("Directory is not a valid "+d.kind+": "+h),e(g)}})}},{key:"nextId",value:function(){var a=this._idSeed||0;return this._idSeed=++a}}]),b}(Base);module.exports=Entity;
"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),util=require("util"),Agent=require("./Agent"),SandboxBrowser=require("../browser/SandboxBrowser"),Util=require("../../Util"),logger=require("../../Logger").getInstance().forClass("model/test/SandboxAgent"),SandboxAgent=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"launch",value:function(){logger.trace(".launch"),logger.debug("Launching sandbox agent");var a,b=this,c=b.agentGroup.browser;return a=b.sandboxBrowser=new SandboxBrowser({browser:c,agent:b,url:b.url,runConfig:{agentId:b.id,runnerId:b.runner.id,orionRecording:b.isRecorder,baseUrl:"http://localhost:"+b.runner.proxy.port,testFramework:b.testFramework,scenarioLibs:b.scenarioLibs,pageObjects:b.pageObjects,testFiles:b.testFiles,scenarioDir:b.scenarioDir,logLevel:logger.getLevel()}}),a.launch()}},{key:"getTestOptions",value:function(){logger.trace(".getTestOptions");var a=this,c=a.runner,d=(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"getTestOptions",this).call(this),e=a.sandboxBrowser.getDriverConfig();return Util.merge(e.desiredCapabilities,a.capabilities),d.driverConfig=e,d.subjectUrl=c.getSubjectUrl(),d}},{key:"screenshot",value:function(a){logger.trace(".screenshot");var b=this;if(b.archiver&&b.archiver.enableScreenshots)return b.archiver.saveScreenshot(a.name,a.data,b)}},{key:"systemError",value:function(a){var b=this;b.terminate()}},{key:"terminate",value:function(){logger.trace(".terminate");var a,b=this;return b._agentTerminatePromise?logger.warn("agent.terminate() called multiple times."):(logger.debug("Waiting on agent to stop WebDriver."),b._agentTerminatePromise=new _promise2["default"](function(c,d){a?c():b.sendMessage({type:"terminate"},!0,function(){a=setInterval(function(){b.isRunning||(logger.debug("Sandbox terminated."),clearInterval(a),a=null,c())},500)})})),b._agentTerminatePromise}},{key:"terminated",value:function(){logger.trace(".terminated");var a=this;a.isRunning=!1,a.fire({type:"terminated",agent:a}),a.sandboxBrowser&&a.sandboxBrowser.task.proc.connected&&a.sandboxBrowser.terminate()}},{key:"browserFullName",get:function(){return logger.trace(".browserFullName"),this.agentGroup.browser.displayLabel}},{key:"userAgentString",get:function(){return logger.trace(".userAgentString"),null}},{key:"contextType",get:function(){return this.webdriverContext||"webdriver"}}],[{key:"meta",get:function(){return{prototype:{isSandboxAgent:!0,terminateOnFinish:!0}}}}]),b}(Agent);(0,_assign2["default"])(SandboxAgent.prototype.supportedMessages,{systemError:1,terminated:1},Agent.supportedMessages),module.exports=SandboxAgent;
"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),fs=require("fs"),mkdirp=require("mkdirp"),Path=require("path"),Url=require("url"),urlParse=Url.parse,AST=require("../../AST"),File=require("../../fs/File"),PageObject=require("./PageObject"),Scenario=require("./Scenario"),TargetUrl=require("../TargetUrl"),util=require("../../Util"),utility=require("util"),xfs=require("../../xfs"),WorkspaceMember=require("../WorkspaceMember"),logger=require("../../Logger").getInstance().forClass("model/test/Project"),Project=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a,b,c=this,d=c.data,e=d.libs,f=d.coverageFilters;for(d.framework=d.framework||"jasmine",d.libs=e||(e=[]),d.coverageFilters=f||(f=[]),c.scenarios=[],c.pageObjects=[],a=e.length;a-- >0;)b=e[a],"string"==typeof b&&(e[a]={path:b});d.scenarios?d.scenarios.forEach(function(a){c.scenarios.push(new Scenario(a,c))}):d.scenarios=[],d.pageObjects?d.pageObjects.forEach(function(a){c.pageObjects.push(new PageObject(a,c))}):d.pageObjects=[]}},{key:"launchAppWatch",value:function(){return!!this.get("launchAppWatch")}},{key:"save",value:function(){var a=[this.getPageObjectPath(),this.getLibPath()];return a.forEach(function(a){var b=xfs.existsSync(a);b||mkdirp.sync(a)}),(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"save",this).call(this)}},{key:"addScenario",value:function(a){var b=new Scenario(a,this);return this.scenarios.push(b),b}},{key:"addPageObject",value:function(a){var b=new PageObject(a,this);return this.pageObjects.push(b),b}},{key:"eachScenario",value:function(a,b){var c,d=this.scenarios,e=d.length;for(c=0;c<e&&a.call(b,d[c])!==!1;++c);}},{key:"eachPageObject",value:function(a,b){var c=this.pageObjects,d=!0,e=!1,f=void 0;try{for(var g,h=(0,_getIterator3["default"])(c);!(d=(g=h.next()).done);d=!0){var i=g.value;if(a.call(b,i)===!1)break}}catch(j){e=!0,f=j}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}}},{key:"getTestFramework",value:function(){var a=this.get("framework");return a||null}},{key:"getOwner",value:function(){var a=this.owner;if(a.isWorkspace){if(a.isSoloApp())return a.apps[0];if(a.isSoloExtReactApp())return a.extreactApps[0]}return a}},{key:"getTargetUrl",value:function(a,b){logger.trace(".getTargetUrl");var c,d=this,e=d.get("subjectUrl"),f=d.getOwner(),g=f&&f.getTargetUrl&&f.getTargetUrl(a,b);return e&&(c=urlParse(e),c.hostname)?e:[g,e].filter(function(a){return!!a}).join("")}},{key:"getWorkspaceMountDir",value:function(){return this.data.workspaceMountDir||this.getWorkspace().dir}},{key:"getScenarioFromPath",value:function(a){var b,c,d,e=File.get(a),f=this.scenarios;for(b=0;b<f.length;b++)if(c=f[b],d=File.get(this.resolve(c.get("directory"))),d.contains(e)||d.equals(e))return c;return null}},{key:"getArchivePath",value:function(){var a,b=this,c=b.owner,d=b.workspace,e=b.data.archivePath;return void 0==e&&(e=c.isApp?Path.join("Applications",c.getName()):c.isPackage?Path.join("Packages",c.getName()):""),c!==d&&d.tests&&(a=d.tests.getArchivePath(),a&&(e=Path.join(a,e))),e}},{key:"getPageObjectPath",value:function(){return Path.join(this.dir,"pageobjects")}},{key:"getLibPath",value:function(){return Path.join(this.dir,"lib")}},{key:"getNodeModulesPath",value:function(){return Path.join(this.dir,"node_modules")}},{key:"getPageObjects",value:function(a){return this.getFilesFromFolder(a,"pageobject")}},{key:"getLibs",value:function(a){return this.getFilesFromFolder(a,"lib")}},{key:"getFilesFromFolder",value:function(a,b){var c=this,d=[],e="pageobject"===b?"pageobjects/":"lib/",f="pageobject"===b?"getPageObjectPath":"getLibPath",g=g="http://foo.com"+c.getWorkspaceRelativePath()+e,h=c[f](),i=xfs.existsSync(h),j=i?xfs.listAllFilesSync(h):[];return j.forEach(function(b){var c,e=b.name;e&&(c=Url.resolve(g,e),c=Url.parse(c),e=(a||"")+c.pathname,d.push(e))}),d}},{key:"hasChild",value:function(a){return xfs.existsSync(Path.join(this.dir,a))}},{key:"visitor",value:function(a,b){var c=a.node,d=b.data,e=b.renameOnly,f=c.key&&c.key.name||null,g=(c.loc&&c.loc.start&&c.loc.start.line||null,[]),h={};for(var i in d.locators)h[i]=!1;if("ExpressionStatement"===c.type&&util.isString(d.name)&&c.expression&&c.expression.callee&&c.expression.callee.object&&c.expression.callee.object.property&&"pageobject"===c.expression.callee.object.property.name&&c.expression.callee.object.object&&"ST"===c.expression.callee.object.object.name){var j=c.expression.arguments[0];"StringLiteral"===j.type&&(j.value=d.name)}if(c.leadingComments&&c.leadingComments.length&&c.leadingComments[0].value.indexOf("@class")!==-1&&(c.leadingComments[0].value=utility.format("*\n* @class stpo.%s\n* @singleton\n",d.name)),"type"===f&&util.isString(d.type)&&(c.value.value=d.type),"_locators"===f){var k=c.value.properties;if(k){k.forEach(function(a){var b=a.key&&a.key.name,c=a.value&&a.value.properties,f=d.locators[b],i=void 0,j=void 0,k=void 0;f?(h[b]=!0,c.forEach(function(a){var b=a.key.name,c=f[b],d=a.value.value;"undefined"!=typeof c&&c!==d&&(a.value.value=c)}),a.leadingComments&&(a.leadingComments[0].value=utility.format("*\n* @method %s\n* @member stpo.%s\n* @return {%s}\n",f.name,d.name,f.className))):e&&a.leadingComments?(k=new RegExp("(stpo."+d.previousName+")","gm"),i="stpo."+d.previousName,j="stpo."+d.name,a.leadingComments[0].value=a.leadingComments[0].value.replace(k,j)):g.push(a)});for(var l in h)if(!h[l]){var m=AST.createObjectProperty(l,d.locators[l]);m.leadingComments=[{type:"CommentBlock",value:utility.format("*\n* @method %s\n* @member stpo.%s\n* @return {%s}\n",l,d.name,d.locators[l].className)}],k.push(m)}g.forEach(function(a){var b=k.indexOf(a);b!==-1&&k.splice(b,1)}),a.stop()}}}},{key:"findPageObject",value:function(a){var b=-1;return this.pageObjects.forEach(function(c,d){c.get("name")===a&&(b=d)}),b}},{key:"savePageObject",value:function(a,b){var c=b?a.name:a.previousName||a.name,d=this.getPageObjectPath(),e=Path.join(d,c+".js"),f=Path.join(d,a.name+".js"),g=a.previousName,h=Path.join(Studio.filesDir.toString(),"templates/pageobjects","Template.js"),i={},j=void 0,k=void 0,l=void 0;j=xfs.existsSync(e)?fs.readFileSync(e,"utf-8"):fs.readFileSync(h,"utf-8"),xfs.existsSync(d)||mkdirp.sync(d);try{k=AST.parse(j)}catch(m){logger.error(m.stack||m)}a.locators.forEach(function(a){i[a.name]=a}),a.locators=i,AST.traverse(k,this.visitor,{data:a,renameOnly:b}),l=AST.generate(k,"code"),fs.writeFileSync(e,l),g&&xfs.rename(e,f)}},{key:"isTestProject",get:function(){return!0}}],[{key:"meta",get:function(){return{mixins:[TargetUrl]}}},{key:"defaultDir",get:function(){return"test"}},{key:"jsonName",get:function(){return"project.json"}},{key:"kind",get:function(){return"Test Project"}}]),b}(WorkspaceMember);module.exports=Project;
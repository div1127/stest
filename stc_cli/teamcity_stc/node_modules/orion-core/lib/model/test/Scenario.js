"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Path=require("path"),Url=require("url"),urlParse=Url.parse,mkdirp=require("mkdirp"),Entity=require("../Entity"),xfs=require("../../xfs"),File=require("../../fs/File"),TargetUrl=require("../TargetUrl"),logger=require("../../Logger").getInstance().forClass("model/test/Scenario"),Scenario=function(a){function b(a,c){(0,_classCallCheck3["default"])(this,b);var d,e=(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).call(this,a)),f=e,a=f.data,g=a.libs||(a.libs=[]),h=(a.coverageFilters||(a.coverageFilters=[]),g.length);for(f.project=c,f.name=a.name;h-- >0;)d=g[h],"string"==typeof d&&(g[h]={path:d});return e}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,null,[{key:"meta",get:function(){return{mixins:[TargetUrl]}}}]),(0,_createClass3["default"])(b,[{key:"setupConventions",value:function(){var a=[this.getLibPath()];a.forEach(function(a){var b=xfs.existsSync(a);b||mkdirp.sync(a)})}},{key:"getGlobals",value:function(){var a,b=this.project.get("globals")||"",c=this.get("globals")||"";for(b=b.trim()+"\n"+c.trim(),b=b.split("\n"),a=b.length;a-- >0;)(b[a]=b[a].trim())||b.splice(a,1);return b}},{key:"getTestFramework",value:function(){var a=this.get("framework"),b=this.project;return!a&&b&&(a=b.getTestFramework()),a||null}},{key:"getTestPath",value:function(){return Path.join(this.project.dir,this.data.directory)}},{key:"getLibPath",value:function(){return Path.join(this.getTestPath(),"lib")}},{key:"getNodeModulesPath",value:function(){return Path.join(this.getTestPath(),"node_modules")}},{key:"getFiles",value:function(a,b){var c,d,e=this,f=a||e.getTestPath(),g=e.files;return c=xfs.listAllFilesSync(f),g=e.files=[],d=function(a,c){a.stat.isDirectory()&&("lib"!==a.name||b)&&"node_modules"!==a.name?a.items.forEach(function(a){d(a,c)}):a.path.endsWith(".js")&&c.push(a.path)},c.forEach(function(a){d(a,g)}),g}},{key:"getAdditionalLibraries",value:function(a){var b=this,c=[],d=b.project.data.libs,e=b.data.libs,f=[];return d&&d.length&&c.push.apply(c,d),e&&e.length&&c.push.apply(c,e),f=b._resolveLibraryPaths(c),b._getPathsForRunner(a,f)}},{key:"_resolveLibraryPaths",value:function(a){var b=this,c=[],d=b.project.workspace.dir;return a.forEach(function(a){try{var e,f=new File(d+a.path);if(a.disabled)return!1;f&&xfs.isDirectory(f)?(e=b.getFiles(f.path,!0),e.forEach(function(a){c.push({disabled:!1,type:"file",path:a.replace(d,"")})})):f.existsSync()?c.push(a):logger.error("Error reading additional library path: "+(d+a.path))}catch(g){logger.error("Error reading additional library path: "+(d+a.path),g.message)}}),c}},{key:"_getPathsForRunner",value:function(a,b){var c=this,d="http://foo.com"+c.project.getWorkspaceRelativePath(),e=[];return b.forEach(function(b){var c,f=b;b&&("string"==typeof b||!b.disabled&&(f=b.path))&&(f.indexOf("://")<0&&(c=Url.resolve(d,f),c=Url.parse(c),f=(a||"")+c.pathname),e.push(f))}),e}},{key:"getTargetUrl",value:function(){logger.trace(".getTargetUrl");var a=this,b=a.get("page"),c=a.project,d=urlParse(b||"");return d.hostname?b:[c.getTargetUrl(a.get("profile"),a),b].filter(function(a){return!!a}).join("")}},{key:"dir",get:function(){return this.project.resolve(this.data.directory)}}]),b}(Entity);module.exports=Scenario;
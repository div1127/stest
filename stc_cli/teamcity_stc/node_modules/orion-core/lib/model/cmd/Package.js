"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),fs=require("fs"),Path=require("path"),CodeBase=require("./CodeBase"),File=require("../../fs/File"),Strings=require("../../Strings"),xfs=require("../../xfs"),Util=require("../../Util"),logger=require("../../Logger").getInstance().forClass("model/cmd/Package"),Package=function(a){function b(a){(0,_classCallCheck3["default"])(this,b);var c=a&&a.sencha,d=(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).call(this,c||a));return c&&!c.name&&(d.inheritedName=!0,c.name=a.name),d.rootData=a,d}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,null,[{key:"meta",get:function(){return{prototype:{isPackage:!0}}}}]),(0,_createClass3["default"])(b,[{key:"loadChildren",value:function(){var a=this,c=a;return(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"loadChildren",this).call(this).then(function(){var b,d=a.get("subpkgs"),e=a.configFile;return d="string"==typeof d?d.split(","):d,e&&(d||(d=e.get("package.subpkgs"),d=d&&d.split(",")),d&&(b=e.get("package.subpkgs.dir")||"",d=d.map(function(a){return Path.join(b,a)}))),d&&d.length?c.loadAll(d,a).then(function(b){return a.packages=b,b&&a.workspace&&b.forEach(function(b){return b.setWorkspace(a.workspace)}),a},function(a){}):a})}},{key:"resolveVariables",value:function(a){return(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"resolveVariables",this).call(this,a).split("${package.dir}").join(this.dir)}},{key:"setSourceFile",value:function(a){(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"setSourceFile",this).call(this,a),this.data.dependencies&&(this.error=new Error("Node modules are not Sencha Cmd packages: "+a))}},{key:"getPersistData",value:function(){var a=this.rootData;return this.inheritedName&&(a=Util.clone(a),delete a.sencha.name),a}},{key:"getTargetUrl",value:function(a){logger.trace(".getTargetUrl");var c=(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"getTargetUrl",this).call(this);return c||(c=this.getGeneratedSubjectUrl(a)),c}},{key:"getTargetPath",value:function(){return""}}],[{key:"grok",value:function(a){var b,c=this;return a=File.get(a),a.path.endsWith(c.jsonName)?a.getStat().then(function(b){return a.stat=b,a}):(b=a.join(c.jsonName),new _promise2["default"](function(d){b.getStat().then(function(e){e===!1?a.getFiles().then(function(a){var b=[],e=[];a.forEach(function(a){a.stat.isDirectory()&&(b.push(a=a.join(c.jsonName)),e.push(a.getStat().then(function(c){if(c===!1){var d=b.indexOf(a);b.splice(d,1)}else a.stat=c})))}),_promise2["default"].all(e).then(function(){d(b)})},function(a){d(null)}):e.isFile()?(b.stat=e,d(b)):d(new Error("Not a valid package location "+a))})}))}},{key:"loadAll",value:function(a,b){var c=this,d=c,e=a,f=[],g=function(a,b){var e=new d;return a.endsWith(c.jsonName)||(a=xfs.join(c.jsonName)),e.setSourceFile(a),e.error=b,f.push(e),e};return"string"==typeof a&&(e=a.split(",")),new _promise2["default"](function(a){var h=[];e.forEach(function(a){b&&(a=b.resolve(a)),h.push(c.grok(a).then(function(c){if(c instanceof Error)return g(a,c);if(c&&c.$isFile){var e=f.length;return f.push(c),d.load(c.path,b).then(function(a){f[e]=a})}if(c&&c.length){var h=[];return c.forEach(function(a){var c=f.length;f.push(a),h.push(d.load(a.path,b).then(function(a){f[c]=a}))}),_promise2["default"].all(h)}}))}),_promise2["default"].all(h).then(function(){f.sort(function(a,b){var c=a.getName(),d=b.getName();return Strings.compareNoCase(c,d)}),a(f)})})}},{key:"configPath",get:function(){return".sencha/package/sencha.cfg"}},{key:"jsonName",get:function(){return"package.json"}},{key:"kind",get:function(){return"Package"}}]),b}(CodeBase);module.exports=Package;
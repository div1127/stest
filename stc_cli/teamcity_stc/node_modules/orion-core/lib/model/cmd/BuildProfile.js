"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Observable=require("../../Observable"),File=require("orion-core/lib/fs/File"),Json=require("orion-core/lib/Json"),appJsTemplate=new File(__dirname).join("app.js.handlebars"),xfs=require("orion-core/lib/xfs"),CmdClient=require("orion-core/lib/cmd/Client"),CmdManager=require("orion-core/lib/cmd/Manager"),path=require("path"),BuildProfile=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;(0,_assign2["default"])(a,{displayName:a.name||"default",watching:!1,building:!1,rootUrl:null,watchTask:null,type:a.owner.isApp?"app":"package",displayType:a.owner.isApp?"App":"Package",tasks:{}})}},{key:"getBuildCommand",value:function(a,b,c,d){return[a,b,d?"-clean":null,this.name,c].filter(function(a){return!!a})}},{key:"_buildLogMessage",value:function(a,b){var c=this,d=a.message.message,e="Writing content to ",f="Appending content to ";if(d)if(d.startsWith(e)&&!c.bootstrapFile){var g=d.substring(e.length);g.endsWith(".json")&&(c.bootstrapFile=g)}else if(!c.bootstrapFile&&d.startsWith(f)){var g=d.substring(f.length);g.endsWith(".json")&&(c.bootstrapFile=g)}}},{key:"_watchLogMessage",value:function(a,b){var c=this,d=a.message.message,e="Waiting for changes...",f="Application available at ";if(d&&(d.startsWith(e)?(c.building=!1,c.fire({type:"watchIdle",task:b,profile:c}),c._buildUnitTestFiles(),c.bootstrapFile=null):(c.building=!0,c.fire({type:"watchBuild",task:b,profile:c})),d.startsWith(f))){var g=d.substring(f.length);g.endsWith("/")||(g+="/"),c.rootUrl=g,c.fire({type:"rootUrl",url:g,profile:c})}}},{key:"_resetWatchStatus",value:function(){(0,_assign2["default"])(this,{watchStarted:!1,watching:!1,building:!1,watchTask:null,rootUrl:null})}},{key:"setBuildTask",value:function(a,b){var c=this;a.on({scope:this,complete:function(a){b||c._buildUnitTestFiles(),c.bootstrapFile=null},logMessage:function(b){c._buildLogMessage(b,a)}})}},{key:"setWatchTask",value:function(a){var b=this;b.watchTask=a,b.watching=!0,b.fire({type:"watchStarted",task:a,profile:b}),a.on({scope:b,complete:function(c){b._resetWatchStatus(),b.fire({type:"watchDone",task:a,profile:b})},logMessage:function(c){b._watchLogMessage(c,a)}}),b.setBuildTask(a,!0)}},{key:"_getAppJsFile",value:function(a){return this.owner._getBuildDir(a).join("app.js")}},{key:"_extractAppJs",value:function(){var a=this,b=a.owner,c=a.name;return b._extractTemplate(appJsTemplate,a._getAppJsFile(c),c,null,b.cmdClient)}},{key:"_buildUnitTestFiles",value:function(){var a,b,c,d=this,e=d.owner,f=d.name,g=d.bootstrapFile,h=e._getBuildDir(f),i=function(a){console.error(a.stack||a)},j=require("yargs").argv;g&&(e.cmdClient||(j.cmd?(c=path.resolve(j.cmd),b=new CmdClient({directory:c})):(a=new CmdManager,b=a.current),e.cmdClient=b),e._extractBuildIndex(f,null,e.cmdClient).then(function(a){d._extractAppJs().then(function(b){Json.read(g).then(function(b){var c,d,g,j,k=new File(e._getBuildDir(f)).join("manifest.json"),l=new File(e.dir),m=e.data.js,n={},o=b.js,p=(b.css,b.paths,[]),q=-1,r=0,s=!1,t=b.loadOrder,u=[],v=".sencha/app";if(c=l.relativeTo(a.getParent()).slashify()+"/",m&&m.length&&m.forEach(function(a){if(a.bundle){var b=l.join(a.path);n[b.getCanonicalPath()]=a}}),o.forEach(function(a){if(!a.remote){var b=l.join(a.path);if(n[b.getCanonicalPath()])return void(s||(s=!0,q=r))}p.push(a),r++}),t&&t.length)for(var w=t.length,x=0;x<w;x++){var y=t[x],z=l.join(y.path);n[z.getCanonicalPath()]&&y.path.endsWith("app.js")&&(u.push({path:c+"app.js"}),t.push({idx:t.length,path:c+"app.js",requires:y.requires,uses:y.uses}))}else u.push({path:c+"app.js"});q>-1?p.splice.apply(p,[q,0].concat(u)):p.push.apply(p,u),b.js=p,k.write((0,_stringify2["default"])(b)),d=xfs.existsSync(l.join(v+"/Boot.js").path),d?(g=l.join(v+"/Boot.js"),j=l.join(v+"/Microloader.js")):(v=e.cmdClient.getAppScriptDir(),g=new File(v+"/Boot.js"),j=new File(v+"/Microloader.js")),g.read().then(function(a){j.read().then(function(b){h.join("bootstrap.js").write(a+"\n"+b)},i)},i)},i)},i)},i))}}]),b}(Observable);module.exports=BuildProfile;
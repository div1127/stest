"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Entity=require("./Entity"),App=require("./cmd/App"),ExtReactApp=require("./extreact/App"),ExtReactPackage=require("./extreact/Package"),Framework=require("./cmd/Framework"),Package=require("./cmd/Package"),Project=require("./test/Project"),Testable=require("./Testable"),Browser=require("orion-core/lib/model/browser/Browser"),GenericBrowser=require("orion-core/lib/model/browser/Generic"),LocalPool=require("orion-core/lib/browser/LocalPool"),Farm=require("orion-core/lib/model/farm/Farm"),Pool=require("orion-core/lib/model/farm/Pool"),BrowserPool=require("orion-core/lib/model/farm/Pool"),SauceLabs=require("orion-core/lib/model/farm/SauceLabs"),BrowserStack=require("orion-core/lib/model/farm/BrowserStack"),Embedded=require("orion-core/lib/model/farm/Embedded"),Json=require("orion-core/lib/Json"),Configuration=require("../config/Configuration"),ArchiveServer=require("orion-core/lib/model/archiveServer/ArchiveServer"),xfs=require("orion-core/lib/xfs"),File=require("orion-core/lib/fs/File"),Util=require("orion-core/lib/Util"),WorkspaceScanner=require("orion-core/lib/model/WorkspaceScanner"),fs=require("fs"),Path=require("path"),farmTypeMap={saucelabs:SauceLabs,browserstack:BrowserStack,generic:Farm},Workspace=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;a.apps=[],a.extreactApps=[],a.extreactPackages=[],a.packages=[],a.frameworks=[],a.farms=[],a.archiveServers=[],a.pathMap={}}},{key:"add",value:function(a){var b,c=this;if(a instanceof App)b=c.apps;else if(a instanceof ExtReactApp)b=c.extreactApps;else if(a instanceof ExtReactPackage)b=c.extreactPackages;else if(a instanceof Framework)b=c.frameworks;else if(a instanceof Package)b=c.packages;else if(a instanceof Farm)b=c.farms;else if(a instanceof ArchiveServer)b=c.archiveServers;else if(!(a instanceof Project))throw new Error("Unrecognized item type");b&&b.push(a),a.dir&&(c.pathMap[xfs.normalize(a.dir)]=a),a.workspace=c}},{key:"eachApp",value:function(a,b){return this._each(this.apps,a,b)}},{key:"eachExtReactApp",value:function(a,b){return this._each(this.extreactApps,a,b)}},{key:"eachExtReactPackage",value:function(a,b){return this._each(this.extreactPackages,a,b)}},{key:"eachFramework",value:function(a,b){return this._each(this.frameworks,a,b)}},{key:"eachPackage",value:function(a,b){return this._each(this.packages,a,b)}},{key:"eachFarm",value:function(a,b){return this._each(this.farms,a,b)}},{key:"eachArchiveServer",value:function(a,b){return this._each(this.archiveServers,a,b)}},{key:"fromPath",value:function(){var a=this.resolve.apply(this,arguments);return a=xfs.normalize(a),this.pathMap[a]||null}},{key:"fromDeepPath",value:function(){var a=this,b=a.resolve.apply(a,arguments),c=xfs.normalize(b),d=a.pathMap,e=!0,f=!1,g=void 0;try{for(var h,i=(0,_getIterator3["default"])((0,_keys2["default"])(d));!(e=(h=i.next()).done);e=!0){var j=h.value;if(0===c.indexOf(j)){var k=d[j];return k}}}catch(l){f=!0,g=l}finally{try{!e&&i["return"]&&i["return"]()}finally{if(f)throw g}}return null}},{key:"getTestScenario",value:function(a,b){var c=this,d=[];d=d.concat(c.apps),d=d.concat(c.packages),c.tests&&d.push(c);var e=!0,f=!1,g=void 0;try{for(var h,i=(0,_getIterator3["default"])(d);!(e=(h=i.next()).done);e=!0){var j=h.value;if(j.tests){var k=!0,l=!1,m=void 0;try{for(var n,o=(0,_getIterator3["default"])(j.tests.scenarios);!(k=(n=o.next()).done);k=!0){var p=n.value,q=File.get(p.resolve()),r=p.get("name");if(b){if(r.toLowerCase().indexOf(b.toLowerCase())>=0)return p}else if(q.equals(a)||q.contains(a))return p}}catch(s){l=!0,m=s}finally{try{!k&&o["return"]&&o["return"]()}finally{if(l)throw m}}}}}catch(s){f=!0,g=s}finally{try{!e&&i["return"]&&i["return"]()}finally{if(f)throw g}}return null}},{key:"isSoloExtReactApp",value:function(){if(1===this.extreactApps.length){var a=this.extreactApps[0];return this.dir===a.dir}return!1}},{key:"isSoloApp",value:function(){if(1===this.apps.length){var a=this.apps[0];return this.dir===a.dir}return!1}},{key:"getTestProjectPath",value:function(){var a=this.get("tests");return a=a&&a.path,a=a&&this.resolve(a)}},{key:"setSourceFile",value:function(a){(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"setSourceFile",this).call(this,a);var c,d=this.data;a&&!d.name&&(c=new File(this.dir).name,d.name=c.charAt(0).toUpperCase()+c.substring(1))}},{key:"setTestProjectPath",value:function(a){var b=this.get("tests");b||this.set("tests",b={}),b.path=a}},{key:"setCmdClient",value:function(a){this.cmdClient=a}},{key:"resolveVariables",value:function(a){return a.split("${workspace.dir}").join(this.dir)}},{key:"update",value:function(a){this.setCmdClient(a),this.loadCmdWorkspace()}},{key:"loadChildren",value:function(){var a=this;return _promise2["default"].all([a._loadTests(),a._loadApps(),a._loadExtReactApps(),a._loadExtReactPackages(),a._loadFrameworks(),a._loadPackages(),a._loadBrowserPools(),a._loadArchiveServers()]).then(function(){return a})}},{key:"loadCmdWorkspace",value:function(){var a=this,b=a.cmdClient,c={application:"app.dir","package":"package.dir",frameworkpackage:"framework.dir"};b&&b.loadWorkspace(a.path).then(function(d){a.cmdConfigs=d.configs,d.children.forEach(function(d){var e=d.config,d=c[d.type];d&&(d=a.fromPath(e[d]),d&&(d.cmdConfig=e,d.cmdClient=b))})})}},{key:"createFarm",value:function(a){var b=this,c=a.type,d=farmTypeMap[c]||Farm,e=new d(a);return c&&!farmTypeMap[c]&&(e.error=new Error('Unknown browser farm type "'+c+'"')),e.workspace=b,b.add(e),e}},{key:"getBrowserFarm",value:function(a){var b,c,d=this.farms;for(a=a.toLowerCase(),c=0;c<d.length;++c)if(a===(b=d[c]).getName().toLowerCase())return b;return null}},{key:"removeFarm",value:function(a){var b=this.farms,c=this.getBrowserFarm(a),d=c?b.indexOf(c):-1;d>-1&&b.splice(d,1)}},{key:"createArchiveServer",value:function(a){var b=this,c=new ArchiveServer(a);return c.workspace=b,b.add(c),c}},{key:"getArchiveServer",value:function(a){var b,c,d=this.archiveServers;for(a=a.toLowerCase(),c=0;c<d.length;++c)if(name===(b=d[c]).server.toLowerCase())return b;return null}},{key:"removeArchiveServer",value:function(a){var b=this.archiveServers,c=this.getArchiveServer(a),d=c?b.indexOf(c):-1;d>-1&&b.splice(d,1)}},{key:"_each",value:function(a,b,c){if(a)for(var d=0;d<a.length&&b.call(c,a[d])!==!1;++d);}},{key:"_loadTests",value:function(){var a=this;return a.loadTests().then(function(b){return b&&a.add(b),b})}},{key:"_loadApps",value:function(){var a=this,b=a.data.apps,c=[];if(b)b.forEach(function(b){b.path&&(b=b.path),c.push(App.load(a.resolve(b),a).then(function(c){return a.add(c),c.setRelativePath(b),c}))});else if(xfs.existsSync(xfs.join(a.dir,"app.json")))return App.load(a.dir,a).then(function(b){return a.add(b),b.setRelativePath(""),b});return _promise2["default"].all(c).then(function(b){return a.apps.sort(function(a,b){var c=a.getName().toLowerCase(),d=b.getName().toLowerCase();return c<d?-1:d<c?1:0}),b})}},{key:"_isExtReactApp",value:function(a){var b,c,d,e=this;return b=e.resolve(a),c=Path.join(b,"node_modules","@extjs","ext-react"),d=Path.resolve(Path.join(b,"package.json")),fs.existsSync(c)&&fs.existsSync(d)}},{key:"_addFailedExtReactApp",value:function(a){var b,c,d,e,f=this;return b=f.resolve(a),c=Path.join(b,"node_modules","@extjs","ext-react"),e=Path.resolve(Path.join(b,"package.json")),d=new ExtReactApp,d.setOwner(f),fs.existsSync(e)&&d.setSourceFile(e),d.error=new Error("Directory is not a valid ExtReact application: "+b),f.add(d),d.setRelativePath(a),d}},{key:"_loadExtReactApps",value:function(){var a,b=this,c=b.data.extreact&&b.data.extreact.apps,d=[];if(c)c.forEach(function(c){c.path&&(c=c.path),a=b.resolve(c),b._isExtReactApp(c)?d.push(ExtReactApp.load(a,b).then(function(a){return b.add(a),a.setRelativePath(c),a})):d.push(b._addFailedExtReactApp(c))});else if(b._isExtReactApp(b.dir))return ExtReactApp.load(b.dir,b).then(function(a){return b.add(a),a.setRelativePath(""),a});return _promise2["default"].all(d).then(function(a){return b.extreactApps.sort(function(a,b){var c=a.getName().toLowerCase(),d=b.getName().toLowerCase();return c<d?-1:d<c?1:0}),a})}},{key:"_loadExtReactPackages",value:function(){var a=this;return ExtReactPackage.loadAll("ext-react/packages",a).then(function(b){b.forEach(a.add,a)})}},{key:"_loadFrameworks",value:function(){var a,c=this,d=new Configuration,e=c.dir+"/.sencha/workspace/sencha.cfg",f=Path.join(c.dir,b.jsonName),g=[];if(xfs.existsSync(f)){var h=Json.readSync(f),i=h.frameworks,j=void 0;if(i)for(var k in i)j=i[k].path,j&&g.push(Framework.load(c.resolve(Path.join(c.dir,j)),c).then(function(a){c.add(a)}))}return g.length||(d.loadSync(e),a=d.get("ext.dir"),a&&g.push(Framework.load(c.resolve(a),c).then(function(a){c.add(a)})),a=d.get("touch.dir"),a&&g.push(Framework.load(c.resolve(a),c).then(function(a){c.add(a)}))),_promise2["default"].all(g)}},{key:"_loadPackages",value:function(){var a=this,b=a.data.packages;return b=b&&b.dir||"packages",Package.loadAll(b,a).then(function(b){b.forEach(a.add,a)})}},{key:"_loadBrowserPools",value:function(){var a,b,c=this,d=c.data.tests,e=[];if(e.push(c._createEmbeddedFarm()),d&&d.browser)if(a=d.browser.farms,b=Array.isArray(a),Array.isArray(a))a.forEach(function(a){var b=c.createFarm(a);b.eachPool(function(a){e.push(a.loadConfigFile())})});else if(a)throw new Error('Invalid workspace.json file: "tests.browser.farms" must be an array');return _promise2["default"].all(e)}},{key:"_loadArchiveServers",value:function(){var a,b,c=this,d=c.data.tests,e=[],f={};if(c.createArchiveServer({local:!0}),d){if(d.archiveServers)if(b=d.archiveServers,Array.isArray(b))b.forEach(function(a){f[a.server]=a.archiveRoot,c.createArchiveServer(a)});else if(b)throw new Error('Invalid workspace.json file: "tests.archiveServers" must be an array');d.archiveRoot&&d.archiveServer&&(a=f[d.archiveServer],a&&a===d.archiveRoot||c.createArchiveServer({server:d.archiveServer,archiveRoot:d.archiveRoot,label:d.archiveServer}))}return _promise2["default"].all(e)}},{key:"getPersistData",value:function(){var a=(0,_assign2["default"])({},(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"getPersistData",this).call(this)),c=a.tests&&a.tests.browser;return c&&c.farms&&(c.farms=c.farms.filter(function(a){return"embedded"!==a.type})),a}},{key:"_createEmbeddedFarm",value:function(){var a=this,b=new Embedded,c=new Pool({name:"Embedded"});return b.workspace=a,a.add(b),a._embeddedFarm=b,c.isEmbeddedPool=!0,b.add(c),new _promise2["default"](function(d,e){var f=new LocalPool,g={description:"Google Chrome",profile:"",type:"chrome",name:"Chrome",detected:!1};f.detect().then(function(){f.browsers.forEach(function(a){"chrome"===a.get("name")&&(0,_assign2["default"])(g,{version:a.data.version,detected:!0})});var e=a._getLocalPlatform(),h=new GenericBrowser(g),i=new GenericBrowser({description:h.description,browserName:h.get("type"),platform:e,detected:h.get("detected"),version:h.displayVersion,sencha:{concurrency:1}});c.add(i),b.set("sessionLimit",1),d()})})}},{key:"_getLocalPlatform",value:function(){return Util.isWindows?"WINDOWS":Util.isLinux?"LINUX":Util.isMac?"MAC":void 0}},{key:"embeddedFarm",get:function(){return this._embeddedFarm}}],[{key:"find",value:function(a){return new _promise2["default"](function(c,d){function e(f){var g,h=f.join(b.jsonName),i=f.join(b.configName);if(h.existsSync())c(h);else if(i.existsSync()){var j=new WorkspaceScanner;j.scan(f).then(function(a){h.writeJson(a,{prettyPrint:!0}).then(function(){c(h)},d)},d)}else g=f.parent,g?e(g):d(xfs.wrapError(a,a+" is not a valid workspace"))}var f=new File(a),g=f;return f.existsSync()?void e(g):void d(xfs.wrapError(a,a+" does not exist"))})}},{key:"meta",get:function(){return{prototype:{isWorkspace:!0},mixins:[Testable]}}},{key:"jsonName",get:function(){return"workspace.json"}},{key:"configName",get:function(){return".sencha/workspace/sencha.cfg"}},{key:"kind",get:function(){return"Workspace"}}]),b}(Entity);module.exports=Workspace;
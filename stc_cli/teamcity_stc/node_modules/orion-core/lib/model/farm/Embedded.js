"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Pool=require("orion-core/lib/model/farm/Pool"),Task=require("orion-core/lib/tasks/Task"),ChildProcessTask=require("orion-core/lib/tasks/ChildProcessTask"),xfs=require("orion-core/lib/xfs"),Json=require("orion-core/lib/Json"),Farm=require("./Farm"),path=require("path"),selenium=require("selenium-standalone"),portfinder=require("portfinder"),util=require("util"),Util=require("orion-core/lib/Util"),File=require("orion-core/lib/fs/File"),fs=require("fs"),logger=require("orion-core/lib/Logger").getInstance().forClass("model/farm/Embedded"),Embedded=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){logger.trace(".ctor");var a=this,b=a.data;b.name=b.name||"Embedded",b.type=b.type||"embedded",b.host=b.host||"localhost",a.set("defaultSeleniumBasePath",xfs.seleniumDir),a.set("seleniumBasePath",xfs.seleniumDir)}},{key:"driverConfig",value:function(a){logger.trace(".driverConfig <= { browserData }");var c=(0,_get3["default"])(b.prototype.__proto__||(0,_getPrototypeOf2["default"])(b.prototype),"driverConfig",this).call(this,a),d=c.desiredCapabilities;return"chromium"===d.browserName&&(d.browserName="chrome"),c}},{key:"getSeleniumServerJarName",value:function(a){return logger.trace(".getSeleniumServerJarName <=",a),a+"-server.jar"}},{key:"getChromeDriverName",value:function(a){return logger.trace(".getChromeDriverName <=",a),a+"-"+process.arch+"-chromedriver"}},{key:"_scaffoldSelenium",value:function(a){logger.trace("._scaffoldSelenium");var b,c,d,e,f,g,h,i=this,j=!1,k=i.get("seleniumBasePath"),l=k.join("selenium-config.json");return xfs.filesDir?(d=xfs.filesDir.join("selenium"),f=d.join("selenium-config.json"),k&&xfs.existsSync(k.path)?(l=k.join("selenium-config.json"),e=k.join("logging.properties"),l&&xfs.existsSync(l.path)&&e&&xfs.existsSync(e.path)?(b=Json.readSync(l.path),c=Json.readSync(f.path),g=b&&b.version||null,h=c&&c.version,g!==h&&(j=!0)):j=!0):j=!0,new _promise2["default"](function(a,c){if(j){var e,g,h,l,m,n,o=k.join("selenium-config.json"),p=k.join("logging.properties"),q=k.join("selenium-server"),r=k.join("chromedriver"),s=f;i.seleniumConfig=Json.readSync(s.path),q.ensurePathExistsSync(),r.ensurePathExistsSync(),l=i.getSeleniumServerJarName(i.seleniumConfig.hub.version),m=q.join(l),e=d.join("selenium-server").join(l),h=i.getChromeDriverName(i.seleniumConfig.node.drivers.chrome.version),n=r.join(h),g=d.join("chromedriver").join(h),xfs.copy(e,m).then(function(){return xfs.copy(g,n)}).then(function(){return fs.chmod(n.path,"0755")}).then(function(){return xfs.copy(d.join("selenium-config.json"),o)}).then(function(){return xfs.copy(d.join("logging.properties"),p)}).then(function(){a()})}else i.seleniumConfig=b,a()})):xfs.exists(l.path).then(function(a){return a?void(i.seleniumConfig=Json.readSync(l.path)):(logger.error("Could not read Selenium configuration from",l.path),_promise2["default"].reject("Error reading Selenium configuration"))})}},{key:"startHub",value:function(){logger.trace(".startHub");var a=this,b=(a.seleniumBasePath,a.hubConfig);return new _promise2["default"](function(c,d){selenium.start(b,function(b,e){b?d(b):(a.seleniumHub=e,c(a))})})}},{key:"startNode",value:function(a,b){logger.trace(".startNode <=",a,b);var c=this,a=a||"http://localhost",b=b||4444,d=util.format("%s:%s/grid/register",a,b),e=(c.seleniumBasePath,c.nodeConfig);return new _promise2["default"](function(a,b){e.seleniumArgs=["--","-role","node","-hub",d],selenium.start(e,function(d,e){d?b(d):(c.seleniumNode=e,a(e))})})}},{key:"_installSelenium",value:function(){logger.trace("._installSelenium");var a=this,b=new Task;return b.setDescription("Selenium Installer"),new _promise2["default"](function(c,d){selenium.install({basePath:a.seleniumBasePath.path},function(a,d){if(a)b.error(a);else{var e=(0,_stringify2["default"])(d,null,4);e.split("\n").forEach(function(a){b.debug(a)})}b.done(),c()})})}},{key:"_startStandaloneServer",value:function(){logger.trace("._startStandaloneServer");var a=this,b=a._getStandaloneServerTask();return new _promise2["default"](function(c,d){b.running?c(b):(b.on({scope:a,single:!0,running:function(){c(b)}}),b.on({scope:a,single:!0,error:function(a){d(a.error)}}))})}},{key:"_getStandaloneServerTask",value:function(){logger.trace("._getStandaloneServerTask");var a=this,b=a._task;return b||(b=a._task=new ChildProcessTask({description:"Selenium Server",launchProcess:a._startSelenium.bind(a),onStderrData:function(a){this.onStdoutData(a)}}),a.onTaskStart(b),b.on({scope:a,complete:function(){a.onTaskStop(),a._task=null}})),b}},{key:"_startSelenium",value:function(){logger.trace("._startSelenium");var a=this;return new _promise2["default"](function(b,c){portfinder.basePort=4450,portfinder.getPort(function(d,e){d&&logger.error(d.stack||d);var f=a.nodeConfig;a._task.setDescription("Selenium Server @ "+e),a.set("port",e),f.seleniumArgs=["-port",e||4450],selenium.start(f,function(a,d){a?(logger.error(a.stack||a),c(a)):(logger.info("Embedded Selenium server started"),b(d))})})})}},{key:"start",value:function(){logger.trace(".start");var a=this;return a._scaffoldSelenium().then(function(){return!0}).then(function(){return a._startStandaloneServer()})}},{key:"stop",value:function(){logger.trace(".stop");var a=this,b=a._task;b&&b.stop()}},{key:"connectionDisplay",get:function(){return"Embedded"}},{key:"hubConfig",get:function(){var a=this.seleniumConfig?this.seleniumConfig.hub||{}:{};return a.seleniumArgs=["--","-role","hub"],logger.trace(".hubConfig => { config }"),a}},{key:"nodeConfig",get:function(){var a=this.seleniumConfig?this.seleniumConfig.node||{}:{},b=this.get("seleniumBasePath").path;return a.basePath=b,a.javaArgs=["-Djava.util.logging.config.file="+path.join(b,"logging.properties")],logger.trace(".nodeConfig => { config }"),a}}],[{key:"meta",get:function(){return{prototype:{isEmbeddedFarm:!0,isPowerable:!0}}}}]),b}(Farm);module.exports=Embedded;
"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}function ignore(){}function exec(a,b){co(a).then(function(a){b&&b(a)},function(a){logger.error(a.stack)})}function sanitize(a){return sanitizeFilename(a||"child").replace(/ /g,"-").substr(0,Math.min(32,a.length))}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Browser=require("orion-core/lib/model/browser/Browser"),Client=require("orion-core/lib/archive/Client"),Comparator=require("orion-core/lib/image/Comparator"),Observable=require("orion-core/lib/Observable"),ReporterBase=require("orion-core/lib/reporter/ReporterBase"),xfs=require("orion-core/lib/xfs"),fs=require("fs"),File=require("orion-core/lib/fs/File"),Zip=require("orion-core/lib/fs/Zip"),path=require("path"),sanitizeFilename=require("sanitize-filename"),util=require("util"),uuid=require("uuid"),co=require("co"),logger=require("../Logger").getInstance().forClass("reporter/ArchiveReporter"),ArchiveReporter=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(a){var b=this;b.id=uuid.v1(),b.buildNumber=b.buildNumber||(new Date).toLocaleString(),b._pendingWrites=0,b._contexts=new _map2["default"],b._descriptors={},b._browsers={},b.idSeed=0,b._enableUpload=!0,void 0===b.enableScreenshots&&(b.enableScreenshots=!0),b.init()}},{key:"init",value:function(){var a,b,c,d=this,e=d.workdir||d.basedir,f=d.baselinedir;logger.debug("Initializing archive reporter"),e||(e=xfs.tempSessionDir.join("reports")),logger.debug("Work dir: "+e),d.workdir=e=new File(e),d.basedir=e.join(d.id),c=d.basedir.path,f||(f=e.join("baseline")),d.baselinedir=new File(f),a=d.scenario.project.getArchivePath(),a.startsWith("/")&&(a=a.substring(1)),d.archivePath=a,d.archivedir=d.basedir.join(a),d.scenariodir=d.archivedir.join(sanitize(d.scenario.get("name"))),b=d.getDescriptor(d.basedir),b.scenarios=[{path:d.basedir.relativeTo(d.scenariodir).path}]}},{key:"removeDirectory",value:function(){this.basedir.remove()}},{key:"disableUpload",value:function(){this._enableUpload=!1}},{key:"flush",value:function(){var a=this;return logger.info("Flushing result queues"),a._flushQueues().then(function(){return delete a._contexts,a.getDescriptor(a.basedir).maxId=a.idSeed,logger.info("Writing results to disk"),a._flushDescriptors()}).then(function(){return logger.info("Compressing result archive"),a._zipArchive()}).then(function(b){if(a._enableUpload&&a.server)return logger.info("Uploading results to server",a.server),a._upload(b)}).then(function(){logger.info("Done")})}},{key:"_flushQueues",value:function(){var a=[],b=!0,c=!1,d=void 0;try{for(var e,f=(0,_getIterator3["default"])(this._contexts.values());!(b=(e=f.next()).done);b=!0){var g=e.value;a.push(g.flush())}}catch(h){c=!0,d=h}finally{try{!b&&f["return"]&&f["return"]()}finally{if(c)throw d}}return _promise2["default"].all(a)}},{key:"_flushDescriptors",value:function(){var a=this;return new _promise2["default"](function(b,c){var d=a._descriptors,e=(0,_keys2["default"])(d),f=e.length,g=0;if(0===f)return void b();var h=!0,i=!1,j=void 0;try{for(var k,l=(0,_getIterator3["default"])(e);!(h=(k=l.next()).done);h=!0){var m=k.value,n=d[m];delete d[m];var o=(0,_stringify2["default"])(n,null,4);m=new File(m);var p=m.join("data.json");p.write(o).then(function(){++g===f&&b()})["catch"](function(a){c(a)})}}catch(q){i=!0,j=q}finally{try{!h&&l["return"]&&l["return"]()}finally{if(i)throw j}}})}},{key:"_zipArchive",value:function(){var a=this;return new _promise2["default"](function(b,c){Zip.fromDir(a.basedir.path,a.workdir.join(a.id+".zip").path).then(function(a){logger.info(util.format("Report archived to %s (%d bytes)",a.fileName,a.bytes)),b(a.fileName)},function(a){c(a)})})}},{key:"_upload",value:function(a){var b=this,c=b.server;if(!c)return _promise2["default"].resolve();var d=new Client({server:b.server});return d.upload(a,{archiveId:b.id,buildNumber:b.buildNumber,storageKey:b.storageKey,archivePath:b.archivePath,overwrite:b.overwrite}).then(function(a){var b=a.toLowerCase().indexOf("warning")>=0;a=""+a,a=a.split("\n");var c=!0,d=!1,e=void 0;try{for(var f,g=(0,_getIterator3["default"])(a);!(c=(f=g.next()).done);c=!0){var h=f.value;b?logger.warn(h):logger.info(h)}}catch(i){d=!0,e=i}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}},function(a){logger.error(a.stack||a)})}},{key:"testSuiteEnter",value:function(a){var b,c,d=this,e=d._getContext(a.agent);a.fileName&&(e.reset(),new File(d.archivePath).getPathParts().forEach(function(a){a&&e.down({name:a,type:"dir"})}),b=d.archivedir.relativeTo(d.scenariodir.join(a.fileName)),c=b.getParentFile(),c.getPathParts().forEach(function(a){a&&e.down({name:a,type:"dir"})}),e.down({name:b.name,type:"file"})),e.down({name:a.name,type:"suite",id:a.id})}},{key:"testSuiteLeave",value:function(a){var b=this,c=b._getContext(a.agent);c.up()}},{key:"testAdded",value:function(a){var b=this,c=b._getContext(a.agent);c.addTest(a)}},{key:"testRunStarted",value:function(a){this.archiveRunning=!0,this._getContext(a.agent).reset()}},{key:"testSuiteStarted",value:function(a){var b=this,c=b._getContext(a.agent);c.suite(a.id)}},{key:"testStarted",value:function(a){var b=this,c=b._getContext(a.agent);c.startTest(a)}},{key:"testFinished",value:function(a){var b=this,c=b._getContext(a.agent);c.endTest(a)}},{key:"testSuiteFinished",value:function(a){var b=this,c=b._getContext(a.agent);c.up()}},{key:"codeCoverageStructure",value:function(a){var b=this,c=b._getContext(a.agent);c.saveCoverageStructure(a.results,null)}},{key:"codeCoverage",value:function(a){var b=this,c=b._getContext(a.agent);c.saveCoverage(a.results,a.name)}},{key:"saveScreenshot",value:function(a,b,c){var d=this,e=d._getContext(c);return e.saveScreenshot(a,b)}},{key:"_ensureBaselineExists",value:function(){var a,b,c=this;return c._ensureBaselineExistsPromise||(c._ensureBaselineExistsPromise=new _promise2["default"](function(d,e){c.server?c._baselineDownloaded?d():(b=new Client({server:c.server}),a=File.join(c.workdir.path,"baseline"),b.download({storageKey:c.storageKey,path:File.join(c.archivePath||"","baseline"),localPath:a}).then(function(){c._baselineDownloaded=!0,d()},function(a){logger.error(a),e(a)})):d()}))}},{key:"_getContext",value:function(a){var b=this,c=b._contexts||(b._contexts=new _map2["default"]),d=a.id;return c.get(d)||c.set(d,b._newContext(a)).get(d)}},{key:"_newContext",value:function(a){var b=this,c=a.agentGroup,d=c.userAgent;if(!b._browsers[c.id]){var e=b.getDescriptor(b.basedir),f=e.browsers||(e.browsers=[]),g=b._getUniqueBrowserId(c),h=a.userAgentString,i=c.browser||new Browser(d.browser),j={id:g,canonicalName:i.canonicalName,version:i.displayVersion,canonicalPlatform:i.canonicalPlatform,displayName:i.displayName,displayPlatform:i.displayPlatform};h&&(j.userAgent=a.userAgentString),f.push(j),b._browsers[c.id]=g}return new Context({reporter:b,archiver:b,dir:b.basedir,browserId:b._browsers[c.id]})}},{key:"_getUniqueBrowserId",value:function(a){var b=this,c=b._browsers,d=a.browser||a.userAgent.browser,e=d instanceof Browser,f=e?d.parsedVersion:d.version,g=e?d.canonicalPlatform:d.platform,h=f&&f.major,i=e?d.canonicalName:d.name.toLowerCase(),j=i+(h||"")+(g||"");if(j=j.replace(/ /g,""),!c[j])return j;for(var k,l=0;l<1e3;l++)if(k=j+"-"+l,!c[k])return k;throw new Error("Unable to generate unique ID for browser "+j)}},{key:"getDescriptor",value:function(a){var b=this,c=b._descriptors[a.path]||(b._descriptors[a.path]=b._newDescriptor());return c}},{key:"_newDescriptor",value:function(){return{id:++this.idSeed,children:[]}}},{key:"_newUniqueDirName",value:function(a,b){for(var c=sanitize(a),d=c,e=!1,f=0;!e;){for(var g=!1,h=0;h<b.length;h++)if(b[h].dir===d){g=!0;break}g?d=c+"~"+ ++f:e=!0}return d}}],[{key:"parsePath",value:function(a,c,d,e){var f,g,h=[],i=a.join("data.json");if(a.existsSync())return f=fs.readFileSync(i.toString(),{encoding:"utf8"}),g=JSON.parse(f),h=g.children,g.scenarios&&(e=g.scenarios),h.forEach(function(f){if(f.dir)f.specPath=d?d.slice():[],f.specPath.push(f.dir),b.parsePath(a.join(f.dir),c,f.specPath,e);else{if(f.specPath=f.specPath||d.slice(),f.specPath.push(f.name),e&&e.length)for(var g="",h=0;h<e.length;h++){for(var i=e[h].path,j="",k=0;k<f.specPath.length;k++){var l=f.specPath[k];if(j+=0===k?l:"/"+l,i===j){g=i;break}}if(g){var m=g.split("/"),n=m[m.length-1];f.scenario=n.replace(/-/," ");break}}c.push(f)}}),g}},{key:"getFailedTests",value:function(a){var c,d,e=[],f=[],g=[],h={};return a.existsSync()&&(c=b.parsePath(a,e),c.browsers.forEach(function(a){h[a.id]=a}),g=c.browsers.map(function(a){return a.id}),e.forEach(function(b){var c=!0,e=!1,i=void 0;try{for(var j,k=(0,_getIterator3["default"])(g);!(c=(j=k.next()).done);c=!0){var l=j.value;if("undefined"!=typeof b[l]&&b[l]===!1){b.archiveDir=a.toString(),b.details.forEach(function(a){d=h[a.browser],a.displayName=d.displayName,a.displayPlatform=d.displayPlatform,a.version=d.version}),f.push(b);break}}}catch(m){e=!0,i=m}finally{try{!c&&k["return"]&&k["return"]()}finally{if(e)throw i}}})),f}}]),b}(ReporterBase),Context=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(a){var b=this;b._promise=_promise2["default"].resolve(),b._map={test:{},suite:{}},b._currentTest=null}},{key:"flush",value:function(){var a=this;return a.queue(new _promise2["default"](function(a,b){a()}))}},{key:"queue",value:function(a){var b=this;return b._promise=b._promise.then(a)}},{key:"suite",value:function(a){var b=this;b.queue(function(){b.dir=new File(b._map.suite[a])})}},{key:"saveCoverageStructure",value:function(a,b){var c=this,d=c.reporter;c.queue(function(){return new _promise2["default"](function(b,e){var f=c.browserId,g="coverage-"+f+"-structure.json",h=new File(c.dir),i=h.join(g),j=d.getDescriptor(c.dir);j.coverages=j.coverages||[],j.coverages.unshift({browserId:f,path:g,structure:!0}),i.write(a).then(b,e)})})}},{key:"saveCoverage",value:function(a,b){var c=this,d=c.reporter;c.queue(function(){return new _promise2["default"](function(e,f){var g=c.browserId,h=new File(c.dir),i="coverage-"+g+".json",j=h.join(i),k=d.getDescriptor(c.dir);if("__init__"===b){var l="Page Initialization";b=sanitize(l),h=d.scenariodir,k=d.getDescriptor(h);var m,n=h.join(b).join("data.json"),o=d.getDescriptor(n.getParentFile()),j=h.join(b).join(i);o.name=l,o.type="file",o.coverages=o.coverages||[],o.coverages.push({browserId:g,path:i}),m=c.getEntryByName(k.children,l),m||(m={name:l,type:"file",dir:b},k.children.push(m)),m.id=o.id,j.write(a).then(e,f)}else k.coverages=k.coverages||[],k.coverages.push({browserId:g,path:i}),j.write(a).then(e,f)})})}},{key:"startTest",value:function(a){var b=this,c=b.reporter;b.queue(function(){var d=b._currentTest=b._map.test[a.id],e=c.getDescriptor(b.dir);e[b.browserId]=e[b.browserId]||0,d[b.browserId]=!0,b.bubbleUp(!0)})}},{key:"endTest",value:function(a){var b=this,c=b.reporter;b.queue(function(){var d,e,f,g,h=b._currentTest,i=a.passed,j=a.id;null==h[b.browserId]?h[b.browserId]=i:h[b.browserId]=!!i&&h[b.browserId],d=b.getDetails(h,b.browserId),e=d.expectations||(d.expectations=[]),d.expectations=e.concat(a.expectations),f=c.getDescriptor(b.dir),g=f[b.browserId]||0,a.passed||g++,f[b.browserId]=g,a.passed||b.bubbleUp(!1),delete b._map.test[j],b._currentTest=null})}},{key:"getDetails",value:function(a,b){for(var c=a.details||(a.details=[]),d=null,e=0;e<c.length;e++)if(c[e].browser===b){d=c[e];break}return d||(d={browser:b},c.push(d)),d}},{key:"bubbleUp",value:function(a){var b,c,d,e=this,f=e.reporter,g=e.dir,h=a?0:1;do d=f.getDescriptor(g),g=g.getParentFile(),b=f.getDescriptor(g),c=e.getEntryById(b.children,d.id),c[e.browserId]=(c[e.browserId]||0)+h,b[e.browserId]=(b[e.browserId]||0)+h;while(g.path!=f.basedir.path);g.path==f.basedir.path&&(b=f.getDescriptor(g),b.id&&delete b.id)}},{key:"reset",value:function(){var a=this;a.queue(function(){var b=a.reporter;a.dir=b.basedir,a._currentTest=null})}},{key:"up",value:function(){var a=this;a.queue(function(){a.dir=a.dir.getParentFile()})}},{key:"getEntryByName",value:function(a,b){return this.getEntryByProperty(a,"name",b)}},{key:"getEntryById",value:function(a,b){return this.getEntryByProperty(a,"id",b)}},{key:"getEntryByProperty",value:function(a,b,c){for(var d=this,e=(d.reporter,0);e<a.length;e++){var f=a[e];if(f[b]===c)return f}return null}},{key:"down",value:function(a){var b=this,c=b.reporter,d=function(){var d,e,f,g=c.getDescriptor(b.dir),h=g.children,i=a.name;return e=b.getEntryByName(h,a.name),e||(e={name:a.name,type:a.type,dir:c._newUniqueDirName(i,h)},h.push(e)),d=e.dir,f=c.getDescriptor(b.dir.join(d)),void 0!==a.id&&(f.id=++c.idSeed),f.name=a.name,f.type=a.type,e.id=f.id,d},e=function(a){return co(_regenerator2["default"].mark(function c(){var d,e;return _regenerator2["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return d=b.dir.join(a),c.next=3,xfs.exists(d);case 3:if(e=c.sent){c.next=7;break}return c.next=7,xfs.mkdir(d);case 7:b.dir=d;case 8:case"end":return c.stop()}},c,this)}))},f=function(){var d=c.getDescriptor(b.dir);d.name||(d.name=a.name,d.type=a.type)},g=function(){var c=a.id;b._map[a.type]||(b._map[a.type]={}),b._map[a.type][c]||(b._map[a.type][c]=b.dir.path)};b.queue(d),b.queue(e),b.queue(f),void 0!==a.id&&b.queue(g)}},{key:"addTest",value:function(a){var b=this,c=b.reporter;b.queue(function(){for(var d=c.getDescriptor(b.dir),e=d.children,f=null,g=0;g<e.length;g++)if(e[g].name===a.name){f=e[g];break}f||(f={id:++c.idSeed,name:a.name,disabled:a.disabled,type:"test"},d.children.push(f)),b._map.test[a.id]=f})}},{key:"saveScreenshot",value:function(a,b){var c=this;if("string"==typeof b)if("function"==typeof Buffer.from)try{b=Buffer.from(b,"base64")}catch(d){b=new Buffer(b,"base64")}else b=new Buffer(b,"base64");return new _promise2["default"](function(d,e){c.queue(co(_regenerator2["default"].mark(function f(){var e,g,h,i,j,k,l,m,n,o;return _regenerator2["default"].wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return f.next=2,c.archiver._ensureBaselineExists();case 2:return e=c.dir.join(c.browserId+"-"+a+".png"),g=c.archiver.basedir.relativeTo(e),f.next=6,e.write(b);case 6:return h=c.archiver.baselinedir.join(g),f.next=9,h.exists();case 9:if(!f.sent){f.next=27;break}return i=new Comparator,f.next=13,i.compare(h.path,e.path);case 13:if(j=f.sent,k=j.diffCount,!k){f.next=24;break}return n=c.dir.join(c.browserId+"-"+a+"-baseline.png"),o=c.dir.join(c.browserId+"-"+a+"-diff.png"),l=c.archiver.basedir.relativeTo(n).slashify(),m=c.archiver.basedir.relativeTo(o).slashify(),f.next=22,j.save(o);case 22:return f.next=24,xfs.copy(h,n);case 24:d({diffCount:k,path:g.slashify(),baseline:l,diff:m}),f.next=28;break;case 27:d({diffCount:0,path:g.slashify()});case 28:case"end":return f.stop()}},f,this)}))["catch"](function(b){logger.error(util.format("Error processing screenshot %s from %s",a,c.browserId)),logger.error(b.stack||b)}))})}}]),b}(Observable);module.exports=ArchiveReporter;
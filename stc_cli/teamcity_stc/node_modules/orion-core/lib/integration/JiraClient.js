"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),jiraclient=require("jira-client"),Observable=require("../Observable"),File=require("orion-core/lib/fs/File"),fs=require("fs"),util=require("util"),logger=require("../Logger").getInstance().forClass("integration/JiraClient"),templates={origin:["h1.Origin","|Scenario|%s|","|Archive Server|%s|","|Archive Root|%s|","|Build #|%s|","|Test Path|%s|"],summary:["h1.Test Run Results","h2.Summary","|| ||Browser||Version||Platform||Expectations||"],summaryRow:["|%s|%s|%s|%s|%s|"],expectation:["h2.{anchor:%s}%s %s (%s) - %s","|| ||Expectation||Baseline||Actual||Diff||"],expectationRow:["|%s|%s|%s|%s|%s|"]},JiraClient=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this,b=a.protocol||"https";a.port||(a.port="https"===b?"443":"80"),a.jiraClient=new jiraclient({protocol:b,host:a.host,port:a.port,username:a.username,password:a.password,apiVersion:"2",strictSSL:!0}),a.url=b+"://"+a.host+":"+a.port+"/browse"}},{key:"init",value:function(){logger.trace(".init");var a=this,b=[];return a.validateUser(!0).then(function(){return b.push(a.getProjects(!0),a.getIssueTypes(!0),a.getStatuses(!0)),_promise2["default"].all(b)})}},{key:"getIssueTypes",value:function(a){logger.trace(".getIssueTypes");var b=this,c=void 0,d=void 0;return b.jiraIssueTypes||(a=!0),!b.jiraIssueTypesPromise||a?b.jiraIssueTypesPromise=new _promise2["default"](function(a,e){b.jiraClient.listIssueTypes().then(function(e){for(b.jiraIssueTypes=e,d=0;d<e.length;d++)c=e[d],logger.debug("Got issue type "+c.id+":"+c.name+" - "+c.description),"Bug"===c.name&&(b.bugTypeId=c.id);a(e)},function(a){logger.error(a.stack||a)})}):b.jiraIssueTypesPromise}},{key:"getPriorities",value:function(a){logger.trace(".getPriorities");var b=this,c=void 0,d=void 0;return b.jiraPriorities||(a=!0),!b.jiraPrioritiesPromise||a?b.jiraPrioritiesPromise=new _promise2["default"](function(a,e){b.jiraClient.listPriorities().then(function(e){for(b.jiraPriorities=e,d=0;d<e.length;d++)c=e[d],logger.debug("Got priority "+c.id+":"+c.name+" - "+c.description);a(e)},function(a){logger.error(a.stack||a)})}):b.jiraPrioritiesPromise}},{key:"getProjects",value:function(a){logger.trace(".getProjects");var b=this,c=void 0,d=void 0;return b.jiraProjects||(a=!0),!b.jiraProjectsPromise||a?b.jiraProjectsPromise=new _promise2["default"](function(a,e){b.jiraClient.listProjects().then(function(e){for(b.jiraProjects=e,d=0;d<e.length;d++)c=e[d],logger.debug("Got project "+c.id+":"+c.key+":"+c.name);a(e)},function(a){logger.error(a.stack||a)})}):b.jiraProjectsPromise}},{key:"getStatuses",value:function(a){logger.trace(".getStatuses");var b=this,c=void 0,d=void 0;return b.jiraStatuses||(a=!0),!b.jiraStatusesPromise||a?b.jiraStatusesPromise=new _promise2["default"](function(a,e){b.jiraClient.listStatus().then(function(e){for(b.jiraStatuses=e,d=0;d<e.length;d++)c=e[d],logger.debug("Got status "+c.id+":"+c.name+" - "+c.description);a(e)},function(a){logger.error(a.stack||a)})}):b.jiraStatusesPromise}},{key:"getVersions",value:function(a){logger.trace(".getVersions");var b,c=this;return c.jiraVersions||(a=!0),!c.getVersionsPromise||a?c.getVersionsPromise=new _promise2["default"](function(a,d){c.jiraClient.getVersions().then(function(d){for(c.jiraVersions=d,b=0;b<d.length;b++)version=d[b],logger.debug("Got version "+version.id+":"+version.key+":"+version.name);a(d)},function(a){logger.error(a.stack||a)})}):c.getVersionsPromise}},{key:"validateProject",value:function(a){logger.trace(".validateProject");var b=this;return logger.debug("Retrieving project: "+a),b.jiraClient.getProject(a).then(function(a){logger.debug("Project successfully found")})["catch"](function(b){return logger.debug(b.stack||b),_promise2["default"].reject("The requested project ("+a+") could not be found.")})}},{key:"validateUser",value:function(a){logger.trace(".validateUser");var b=this;return b.jiraUser||(a=!0),!b.validateUserPromise||a?b.validateUserPromise=new _promise2["default"](function(a,c){logger.debug("Getting current user"),b.jiraClient.getCurrentUser().then(function(c){logger.debug("User found.",c),b.jiraUser=c,a(!0)})["catch"](function(a){logger.debug(a.stack||a),c("There was an error connecting to the service. Please make sure you have a valid credential and that you have an active internet connection.")})}):b.validateUserPromise}},{key:"addAttachments",value:function(a,b){logger.trace(".addAttachment <= jiraIssue, issue");var c=this,d=void 0,e=void 0,f=void 0,g=void 0,h=void 0,i=void 0,j=[],k=!1,l=!1,m=!1;return d=new File(b.archiveDir),e=b.details,e.forEach(function(b){f=b.expectations,f.forEach(function(b){if(b.screenshot){k=!0;try{g=fs.createReadStream(d.join(b.screenshot).path),logger.debug("attaching actual screenshot to "+a+"("+g.path+")"),j.push(c.jiraClient.addAttachmentOnIssue(a,g))}catch(e){logger.error(e.stack||e)}}if(b.baseline){l=!0;try{h=fs.createReadStream(d.join(b.baseline).path),logger.debug("attaching baseline screenshot to "+a+"("+h.path+")"),j.push(c.jiraClient.addAttachmentOnIssue(a,h))}catch(e){logger.error(e.stack||e)}}if(b.diff){m=!0;try{i=fs.createReadStream(d.join(b.diff).path),logger.debug("attaching diff screenshot to "+a+"("+i.path+")"),j.push(c.jiraClient.addAttachmentOnIssue(a,i))}catch(e){logger.error(e.stack||e)}}})}),logger.trace(".addAttachment => attachmentPromises"),j.length>0?_promise2["default"].all(j):(logger.warn("No attachments for issue "+a+"."),_promise2["default"].reject("No attachments for issue "+a+"."))}},{key:"addIssue",value:function(a,b){logger.trace(".addIssue <= ","project, issue");var c=this,d=void 0,e=void 0;return a||c.jiraProject?(a=a||c.jiraProject,d=c.translateIssue(a,b),c.jiraClient.addNewIssue(d).then(function(a){return e={id:a.id,key:a.key},logger.debug("Issue added: "+e.id+":"+e.key),c.addAttachments(a.key,b).then(function(){return c.findIssue(a.key)},function(b){return c.findIssue(a.key)})},function(a){return logger.error("Issue failed to be created",a),_promise2["default"].reject("An error occurred adding a new issue: ",a)})):_promise2["default"].reject("A project key is required")}},{key:"addIssues",value:function(a,b){logger.trace(".addIssues","project","issues");var c=this;b.forEach(function(b){c.addIssue(a,b)})}},{key:"findIssue",value:function(a){logger.trace(".findIssue <= ",a);var b=this;return b.jiraClient.findIssue(a).then(function(b){return logger.debug("Status for "+a+": "+b.fields.status.name),b})["catch"](function(a){logger.error(a.stack||a)})}},{key:"findIssues",value:function(a){logger.trace(".findIssues","issues")}},{key:"translateIssue",value:function(a,b){var c=this,d=b.name,e=b.details,f=b.specPath,g=b.server,h="",i=templates.summary.join("\n"),j="",k=void 0;return k=[b.scenario,g.archiveServer,g.archiveRoot,g.buildNumber,f.join("/")],h+=templates.origin.join("\n"),k.unshift(h),h=util.format.apply(this,k),"string"!=typeof a&&(b=a),e.forEach(function(a){var c,d,e,f=0,g=0,h=!b[a.browser];c=[h?"(x)":"(/)",util.format("[%s|#%s]",a.displayName,a.browser),a.version,a.displayPlatform||"N/A"],d=[a.browser,a.displayName,a.version,a.displayPlatform||"N/A",h?"{color:red}Failed{color}":"{color:green}Passed{color}"],j+="\n"+templates.expectation.join("\n"),d.unshift(j),j=util.format.apply(this,d),a.expectations.forEach(function(a){var b,c,d=a.passed,e=a.screenshot&&a.screenshot.split("/"),g=a.baseline&&a.baseline.split("/"),h=a.diff&&a.diff.split("/");b=[a.passed?"(/)":"(x)",a.message,g?util.format("!%s|thumbnail!",g[g.length-1]):"N/A",e?util.format("!%s|thumbnail!",e[e.length-1]):"N/A",h?util.format("!%s|thumbnail!",h[h.length-1]):"N/A"],c="\n"+templates.expectationRow.join("\n"),b.unshift(c),c=util.format.apply(this,b),j+=c,d&&f++}),f>0&&(g=100*(f/a.expectations.length).toFixed(2)),c.push(util.format("%s/%s (%s%)",f,a.expectations.length,g)),e="\n"+templates.summaryRow.join("\n"),c.unshift(e),e=util.format.apply(this,c),i+=e}),h+="\n"+i+"\n"+j,{fields:{project:{key:a},summary:d,issuetype:{id:c.bugTypeId},description:h}}}}]),b}(Observable);module.exports=JiraClient;
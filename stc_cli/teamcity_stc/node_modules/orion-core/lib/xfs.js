"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),Util=require("orion-core/lib/Util"),fs=require("fs"),path=require("path"),File=require("./fs/File"),slashRe=/\\/g,os=require("os"),uuid=require("uuid"),child_process=require("child_process"),logger=require("./Logger").getInstance().forClass("xfs"),xfs={splitRe:/[\/\\]/g,separator:File.separator,session:(global.isSandbox?"sandbox-":"session-")+uuid.v1(),homeDir:new File(os.homedir()),childProcesses:[],setTempDir:function(a){var b=xfs;a.$isFile||(a=new File(a)),b.tempDir=new File(a,"Sencha-Studio"),b.tempSessionDir=new File(b.tempDir,b.session),b.tempSessionDir.ensurePathExists(),b.tempSessionDir.removeOnExit()},exists:function(a,b){return"function"!=typeof b?new File(a).exists():void new File(a).exists().then(function(a){b(a)})["catch"](function(a){console.error(a.stack||a)})},existsSync:function(a){try{return fs.accessSync(a,fs.F_OK),!0}catch(b){return!1}},normalize:function(a){return(a||"").replace(slashRe,"/")},wrapError:function(a,b){return File.wrapError(a,b)},dirList:function(a,b){return new File(a).getFiles(b)},dirListSync:function(a,b){return new File(a).getFilesSync(b)},listAllFilesSync:function(a){return xfs.dirListSync(a,!0)},isDirectory:function(a){return new File(a).isDirectory()},isFile:function(a){return new File(a).isFile()},join:function(){return File.join.apply(File,arguments)},flatten:function(a){return File.flatten(a)},resolve:function(){return path.resolve.apply(path,arguments)},split:function(a){return File.split(a)},getRelativePath:function(a,b){return new File(a).relativeTo(b).path},mkdir:function(a){return new File(a).ensurePathExists()},writeFile:function(a,b,c){return new File(a).write(b,c)},removeFile:function(a){return new File(a).remove()},copy:function(a,b){return new _promise2["default"](function(c,d){function e(a){f||(a?d(a):c(),f=!0)}var f=!1;a+="",b+="";var g=fs.createReadStream(a);g.on("error",function(a){e(a)});var h=fs.createWriteStream(b);h.on("error",function(a){e(a)}),h.on("close",function(a){e()}),g.pipe(h)})},rename:function(a,b){return new _promise2["default"](function(c,d){fs.rename(a,b,function(a){a?d(a):c()})})},readFile:function(a,b){return new File(a).read(b)},setBinDir:function(a,b){var c,d=this;if(a=new File(a),b){do c=a.name,a=a.parent;while("app.asar"!==c);a=Util.isMac?a.parent.parent.parent:a.parent}d.binDir=a},setFilesDir:function(a){this.filesDir=new File(a)},setSeleniumDir:function(a){this.seleniumDir=new File(a)},runCommands:function(a,b,c){var d,e,f="win32"===os.platform()||"win64"===os.platform()?" & ":";",g=this.callIndex++,h=this;null!==this.removalTimer&&clearTimeout(this.removalTimer),"darwin"!==os.platform()&&"linux"!==os.platform()||a.unshift("export LC_CTYPE=en_US.UTF-8"),d=a.join(f),e=child_process.exec(d,function(a,e,f){var i=f.toString(),j=e.toString();console.log("async call end: "+g),i&&j&&(i=i.split("\n"),i=i.filter(function(a){return!a.match(/^sed:.*No such file or directory$/)||(console.log("removing sed error from cmd output"),!1)}),i=i.join("\n")),b.call(c,i,j,d),h._scheduleChildRemoval()}),h.childProcesses.push(e)},_scheduleChildRemoval:function(){var a=this;null!==this.removalTimer&&clearTimeout(this.removalTimer),this.removalTimer=setTimeout(function(){a.childProcesses=[]},3e4)}};xfs.profileDir=new File(function(){var a=os.homedir();switch(os.platform()){case"win32":return xfs.join(process.env.USERPROFILE,".sencha");case"darwin":return xfs.join(a,"Library/Application Support/Sencha");case"linux":return xfs.join(a,".local/share/data/Sencha")}return xfs.join(a,".sencha")}()),xfs.seleniumDir=new File(function(){var a=xfs.profileDir;return xfs.join(a.path,"Studio","selenium")}()),xfs.electronDir=new File(function(){var a;try{a=require("electron")}catch(b){if(a=process.execPath,Util.isMac){var c="/Frameworks/Sencha Studio Helper.app/Contents/MacOS/Sencha Studio Helper",d="/MacOS/Sencha Studio";a=a.replace(c,d)}}return a}()),module.exports=xfs;
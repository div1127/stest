"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Url=require("url"),urlParse=Url.parse,AgentGroup=require("../model/test/AgentGroup.js"),LocalBrowserPool=require("../browser/LocalPool"),MessageValidator=require("./MessageValidator"),Observable=require("../Observable"),ProxyServer=require("../web/ProxyServer"),UserAgent=require("../model/UserAgent.js"),Util=require("../Util"),logger=require("../Logger").getInstance().forClass("test/BaseRunner"),BaseRunner=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){logger.trace(".ctor");var a,c,d=this;d.id=++b._idSeed,d._timeStamp=+new Date,d._agentIdSeed=0,d._agentGroupIdSeed=0,d.agents={},d.agentGroups={},d.agentGroupsByBrowserId={},d.agentGroupsByUserAgent={},d._sessionCount={},d._validator=new MessageValidator,d.currentRunId=0,d.messageChunkSize=d.messageChunkSize||0,d._messageQueue=[],d.scenario=d.scenario.descriptor||d.scenario,d.project=d.scenario.project,d.enableCodeCoverage=d.enableCodeCoverage||!1,d.callbackAddress=d.callbackAddress||Util.getLocalIpAddress(),d._setFiles(d.files||[]),a=d.proxy&&!d.proxy.stopped?d.proxy:d.proxy=new ProxyServer({port:d.port,portSeed:d.portSeed,noProxy:d.noProxy,scenario:d.scenario}),c=a.getRootResponder(),c.clearInterceptors(),c.register({"~orion":{routes:{register:{get:function(a){return d._onAgentRegister({request:a.request,response:a.response,agentId:parseInt(a.url.query.agentId,10),proxyId:a.url.query.proxyId,sessionId:a.url.query.sessionId,runnerId:a.url.query.runnerId,url:a.url,content:a.content,address:this.getRequestAddress(a.request),isLocal:this.isLocalRequest(a.request)})}},messages:{get:function(a){return d._onAgentMessages({request:a.request,response:a.response,agentId:parseInt(a.url.query.agentId,10),proxyId:a.url.query.proxyId,runId:parseInt(a.url.query.runId,10),url:a.url,content:a.content})}},updates:{get:function(a){return d._onAgentUpdates({response:a.response,agentId:parseInt(a.url.query.agentId,10),proxyId:a.url.query.proxyId,runId:parseInt(a.url.query.runId,10),url:a.url,content:a.content})}}}}})}},{key:"fail",value:function(){this._passed=!1}},{key:"setDefaultProxyUrl",value:function(a){this.defaultProxyUrl=this.proxy.getRootResponder().defaultProxyUrl=a}},{key:"startTestRun",value:function(a){logger.trace(".startTestRun","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a)),a=a||{};var b,c,d,e,f,g,h,i,j,k=this,l=a.browsers,m=a.agentGroups||[],n=a.files,o=k.reporter,p=a.testIds,q=k.enableCodeCoverage;if(k.currentRunId&&(k._timeStamp=+new Date),k._passed=!0,k._messageQueue.length=0,k._runningAgents=0,k._queuedAgents=0,k.currentRunId++,k.enableCodeCoverage=!!a.enableCodeCoverage,k.testOptions=a.testOptions,j=k.enableCodeCoverage!=q,!n)throw new Error("No test files to run.");return k._runTestBuild().then(function(){k._setFiles(n),o.dispatch({type:"runStarted",files:n,testIds:p,browsers:l,agentGroups:m}),m&&(m=m.slice(),m.forEach(function(a){var b=a.browser;b&&!b.isLocalBrowser||k.launchLocalBrowser(b,a)})),l&&l.forEach(function(f){if(c=k.agentGroupsByBrowserId[f.id],f.isLocalBrowser)return c||(c=k.launchLocalBrowser(f)),void m.push(c);for(b=f.pool.farm,c||(c=k._getAgentGroup({id:k._generateAgentGroupId(),browser:f,browserPool:f.pool})),g=f.get("sencha").concurrency,h=f.get("chunks"),!g&&h&&logger.print("Use of chunks is deprecated. Use sencha.concurrency instead."),g=Math.min(g||h,n.length),i=1;i<=g;i++)d=k._generateAgentId(),e=k._getAgent({id:d,farm:b,agentGroup:c,testIds:p,chunk:i,chunks:g,timeout:k.timeout,remoteTimeout:k.remoteTimeout,capabilities:a.capabilities,url:k.getAgentContactUrl({orionAgentId:d,orionChunk:i+"/"+g},!b)}),e.on("terminated",function(a){k.onRemoteAgentTerminated(a.agent)}),e.on("failed",function(a){var b=a.error,c=a.agent;c.farm,c.browser;o.dispatch({type:"agentFailed",error:b,willRetry:c.retries>0,agent:c}),c.retries--?k._launchAgent(c,j):(o.dispatch({type:"systemError",error:b,agent:c}),k.onRemoteAgentTerminated(a.agent))}),o.dispatch({type:"agentAdded",agent:e}),k._scheduleAgent(e,j)}),m&&m.forEach(function(a){f=a.agents;for(d in f)e=f[d],o.dispatch({type:"agentAdded",agent:e}),e.startTestRun(k.currentRunId,p,j)})},function(a){return k.stopTestRun(),logger.error(a.stack||a),_promise2["default"].reject(a)})}},{key:"startProxy",value:function(){logger.trace(".startProxy"),this.proxy.start()}},{key:"stopTestRun",value:function(){logger.trace(".stopTestRun"),this._messageQueue.length=0,this.cleanupAgents()}},{key:"parameterizePage",value:function(a,b){logger.trace("parameterizePage",a,"undefined"==typeof b?"undefined":(0,_typeof3["default"])(b));var c=urlParse(a,!0),d="&";if(b)for(var e in b){var f=b[e];null!=f&&(d=0!==c.search.indexOf("?")?"?":"&",c.search+=d+e+"="+f)}return Url.format({pathname:c.pathname,search:c.search,hash:c.hash})}},{key:"getTestOptions",value:function(){logger.trace(".getTestOptions");var a=this,b=a.scenario,c=b.project,d={};return(0,_assign2["default"])(d,c.data.options),(0,_assign2["default"])(d,b.data.options),(0,_assign2["default"])(d,a.testOptions),d}},{key:"cleanupAgents",value:function(){logger.trace(".cleanupAgents");var a,b,c=this,d=c.agents;for(a in d)b=d[a],b.terminateOnFinish?b.terminate():b.isRemoteAgent||c.parkAgent(b)}},{key:"removeAgent",value:function(a){function b(){logger.debug("Removing agent",f),g[f]&&(e&&e.dispatch({type:"agentTerminated",agent:a}),a.sendMessage({type:"terminated"}),d&&d.remove(a),delete g[f],a.removed=!0)}var c=this,d=a.agentGroup,e=c.reporter,f=a.id,g=c.agents,h=c._messageQueue;logger.trace(".removeAgent",f),h.length?h.unshift(b):b()}},{key:"destroy",value:function(){logger.trace(".destroy");var a=this;return a.destroyed=!0,a._messageQueue.length=0,a.cleanupAgents(),a.proxy.stop(),_promise2["default"].resolve()}},{key:"onRemoteAgentTerminated",value:function(a){logger.trace(".onRemoteAgentTerminated",a.id);var b=this,c=a.farm;b._runningAgents--,c&&(c.sessionCount--,c.agentQueue.length&&(b._queuedAgents--,b._scheduleAgent(c.agentQueue.shift()))),b._runningAgents||b._queuedAgents||b.fire({type:"terminated",passed:b._passed})}},{key:"fail",value:function(){logger.trace(".fail"),this._passed=!1}},{key:"_runTestBuild",value:function(){logger.trace("._runTestBuild");var a=this,b=a.scenario,c=b.project,d=b.get("profile"),e=c.owner,f=!1;return new _promise2["default"](function(c,g){if(e&&(e.isApp?b.get("launch")||(f=!0):f=!0,f=f&&e.needsDevBuild&&e.needsDevBuild(d)),f){var h=a.cmdClient;h?(e.appWatchInProcess=!0,e.runTestBuild(h,d,!1,function(a){var b=a.message.message;logger.print(b)}).then(c,g)):g("Test Build needed, but Cmd installation not detected")}else c(a)})}},{key:"_getChunkFiles",value:function(a,b){logger.trace(".getChunkFiles <=",a,b);var c=this,d=c._getFiles();return a?(d=c._split(d,b),d[a-1]):d}},{key:"_split",value:function(a,b){var c=a.length,d=[],e=0;for(logger.trace(".split","["+c+"]",b);e<c;){var f=Math.ceil((c-e)/b--);d.push(a.slice(e,e+=f))}return d}},{key:"_getFiles",value:function(){logger.trace("._getFiles");var a=this,b=a.files;return b&&0!==b.length||(b=a.scenario.getFiles()),b.map(function(a){return a.replace(/\\/g,"/")})}},{key:"_setFiles",value:function(a){logger.trace("._setFiles","["+a.length+"]"),this.files=a}},{key:"_generateAgentId",value:function(){return logger.trace("._generateAgentId"),++this._agentIdSeed}},{key:"_getAgent",value:function(a){logger.trace("._getAgent","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a));var b=this,c=a.id,d=b.agents,e=a.agentGroup,f=d[c];return f?(0,_assign2["default"])(f,a):d[c]=f=b._createAgent(a),f.on({lostconnection:"_onAgentLostConnection",terminated:"_onAgentTerminated",agentfinished:"_onAgentFinished",scope:b}),e&&e.add(f),f.runner=b,f}},{key:"_generateAgentGroupId",value:function(){return logger.trace("._generateAgentGroupId"),++this._agentGroupIdSeed}},{key:"_getAgentGroup",value:function(a){logger.trace("._getAgentGroup","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a));var b=a.id,c=this.agentGroups,d=c[b],e=a.userAgent,f=a.browser;return d?(0,_assign2["default"])(d,a):(d=c[b]=new AgentGroup(a),f&&(this.agentGroupsByBrowserId[f.id]=d),e&&this._setAgentGroupUserAgent(d,e)),d}},{key:"_onAgentAdded",value:function(a){logger.trace("_onAgentAdded","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a));var b=this.reporter;b&&b.dispatch({type:"agentAdded",agent:a})}},{key:"_onAgentRegister",value:function(a){logger.trace("._onAgentRegister","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a));var b,c,d,e,f,g=this,h=a.request,i=a.address,j=a.isLocal,k=g.agents,l=(h.headers["user-agent"],UserAgent.fromRequest(h)),m=a.sessionId,n=a.agentId,o=a.runnerId,p=k[n],q=g.reporter;if(o!=g.id)return[{type:"reload",forced:!0}];if(!a.sessionId)return[{type:"error",message:"test agent must supply sessionId during registration"}];if(!p||p.sessionId&&p.sessionId!==a.sessionId){if(c=!0,b=g.agentGroupsByUserAgent[l.groupId],b&&b.count()){e=b.agents;for(f in e)g.parkAgent(e[f])}n=g._generateAgentId(),p=g._getAgent({id:n}),j&&!b&&(d=LocalBrowserPool.instance.lookupBrowserByUserAgent(l),d&&(b=g.agentGroupsByBrowserId[d.id])),b||(b=g._getAgentGroup({id:g._generateAgentGroupId(),browserPool:j?LocalBrowserPool.instance:null,browser:d||null})),b.add(p)}else b=p.agentGroup;return p.userAgent=l,d=b.browser,d&&!p.isSandboxAgent&&(d.userAgent=l,!d.parsedVersion&&l.browser&&(d.parsedVersion=l.browser.version)),(c||d&&d.isLocalBrowser)&&(g._setAgentGroupUserAgent(b,l),b.address=p.address=i),c&&g._onAgentAdded(p),p.sequence=0,p.sessionId=m,p.onRegister().then(function(){q.dispatch({type:"agentRegistered",agent:p})},function(a){logger.error(a.stack||a)}),[{type:"handshake",agentId:n,proxyId:g.proxy.id}]}},{key:"_onAgentMessages",value:function(a){var b,c=this,d=a.agentId,e=a.proxyId,f=a.response,g=c.agents[d];return logger.trace("._onAgentMessages",d),g&&e==c.proxy.id?(b=c._onAgentUpdates(a),b&&"function"==typeof b.then&&b.then(function(a){a.forEach(function(a){g.sendMessage(a)})}),g.onConnectionOpen(f),g.getMessages()):c._redirectUnknownAgent()}},{key:"_onAgentUpdates",value:function(a){var b=this,c=a.agentId,d=b.agents[c],e=a.proxyId,f=a.content;return logger.trace("._onAgentUpdates",c),d&&e==b.proxy.id?void(!f||a.runId&&a.runId!==b.currentRunId||this._queueMessages(JSON.parse(f),d)):b._redirectUnknownAgent()}},{key:"_setAgentGroupUserAgent",value:function(a,b){logger.trace("._setAgentGroup","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a),b),a.userAgent=b,this.agentGroupsByUserAgent[b.userAgent]=a}},{key:"_onAgentLostConnection",value:function(a){logger.trace("._onAgentLostConnection","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a));var b=this.reporter;b&&b.dispatch({type:"agentLostConnection",agent:a.sender})}},{key:"_onAgentTerminated",value:function(a){logger.trace("._onAgentTerminated","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a)),this.removeAgent(a.sender)}},{key:"_onAgentFinished",value:function(a){logger.trace("._onAgentFinished","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a));var b=a.sender;b.isRunning=!1,this.parkRunner&&!b.isSandboxAgent&&(logger.debug("Parking agent",b.id),this.parkAgent(b))}},{key:"_scheduleAgent",value:function(a,b){logger.trace("._scheduleAgent","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a),b);var c=this,d=a.farm;if(d){var e=Math.max(d.sessionLimit||0,1);d.sessionCount<e?(c._runningAgents++,d.sessionCount++,d.start().then(function(){c._launchAgent(a)})):(c._queuedAgents++,d.agentQueue.push(a))}else a.startTestRun(c.currentRunId,null,b),c._runningAgents++}},{key:"_launchAgent",value:function(a,b){logger.trace("._launchAgent","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a),b);var c=this;c.reporter.dispatch({type:"agentLaunched",agent:a}),a.launch().then(function(){c.fire({type:"agentLaunched",agent:a}),a.startTestRun(c.currentRunId,null,b)})}},{key:"_redirectUnknownAgent",value:function(){logger.trace("._redirectUnknownAgent");var a=this,b=a.parkingLot;return b?[{type:"redirect",port:b.getPort()}]:[{type:"redirect",url:"about:blank"}]}},{key:"_queueMessages",value:function(a,b){var c,d,e=this,f=e.messageChunkSize,g=e._messageQueue,h=!g.length,i=a.length,j=[];return logger.trace("_queueMessages",b.id,"[",i,"]"),new _promise2["default"](function(k,l){if(j.push(k),f)for(c=0,d=Math.ceil(i/f);c<i;c+=f,d--)j[d]={agent:b,messages:a.slice(c,c+f)};else j[1]={agent:b,messages:a};g.unshift.apply(g,j),h&&e._scheduleMessageChunk()})}},{key:"_scheduleMessageChunk",value:function(){logger.trace("._scheduleMessageChunk");var a=this,b=a.deferFn;a._messageQueue.length&&(b?b(a._nextMessageChunk,a):a._nextMessageChunk())}},{key:"_nextMessageChunk",value:function(){logger.trace("._nextMessageChunk");var a,b,c=this,d=c._messageQueue;d.length&&(a=d.pop(),"function"==typeof a?(a(),c._scheduleMessageChunk()):(b=a.agent,b.removed?(logger.debug("Ignoring messages for removed agent",b.id),d.length&&c._scheduleMessageChunk()):c._processMessages(a.messages,b).then(function(a){a.forEach(function(a){b.sendMessage(a)}),c._scheduleMessageChunk()})))}},{key:"_processMessages",value:function(a,b){var c,d,e=this,f=a.length,g=e._validator,h=[];for(logger.trace("._processMessages",b.id,"[",f,"]"),c=0;c<f;c++)d=a[c],logger.debug("Processing message:",d),g.validate(d)?(e.reporter&&(logger.debug("Dispatching message:",d.type),e.reporter.dispatch((0,_assign2["default"])({agent:b},d))),h.push(b.dispatch(d))):logger.error("Invalid message received",d);return _promise2["default"].all(h.filter(function(a){return!!a}))}},{key:"_wrapReporters",value:function(a){var b=this;a=Array.isArray(a)?a.slice(0):[a],logger.trace("._wrapReporters","[",a.length,"]");var c={add:function(b){a.indexOf(b)<0&&a.push(b)},dispatch:function(c){var d=c.type;logger.debug("Dispatching",d),b.destroyed||a.forEach(function(a){try{a.supportedMessages[d]&&a.dispatch(c)}catch(b){logger.error(b.stack||b)}})},remove:function(b){var c=a.indexOf(b);c>=0&&a.splice(c,1)}};return c}},{key:"reporter",set:function(a){this._reporter=this._wrapReporters(a)},get:function(){return this._reporter}}]),b}(Observable);BaseRunner._idSeed=0,module.exports=BaseRunner;
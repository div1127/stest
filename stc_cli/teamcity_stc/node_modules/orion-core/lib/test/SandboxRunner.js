"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),path=require("path"),BaseRunner=require("./BaseRunner"),SandboxAgent=require("../model/test/SandboxAgent.js"),xfs=require("../xfs"),logger=require("../Logger").getInstance().forClass("test/SandboxRunner"),SandboxRunner=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){logger.trace(".ctor");var a,b=this,c=b.proxy,d=c.getRootResponder();a=b.getInterceptablePage(),a.endsWith("index.html")&&(a=a.replace(/\/index\.html$/g,"/(index.html)?")),d.intercept("[/]?"+a+"[/]?$",b._interceptSubjectPage.bind(b))}},{key:"getInterceptablePage",value:function(){logger.trace(".getInterceptablePage");var a=this.scenario.getSubjectPage();return logger.trace(".getInterceptablePage =>",a),a}},{key:"_interceptSubjectPage",value:function(a,b){return logger.trace("._interceptSubjectPage"),a}},{key:"getAgentContactUrl",value:function(a,b){logger.trace(".getAgentContactUrl");var c=path.join(__dirname,"..","..","sandbox");return c=xfs.resolve(c),c=xfs.normalize(c),"file://"+c+"/sandbox.html"}},{key:"_createAgent",value:function(a){logger.trace("._createAgent");var b=this,c=b.scenario,d=xfs.normalize(b.project.resolve(c.get("directory"))),e=xfs.normalize(b.project.getWorkspaceMountDir()),f=new b.AgentClass((0,_assign2["default"])({archiver:b.archiver,testFramework:c.getTestFramework(),webdriverContext:c.get("webdriverContext"),scenarioLibs:b.scenario.getAdditionalLibraries(e),pageObjects:b.scenario.project.getPageObjects(e),testFiles:b._getChunkFiles(a.chunk,a.chunks),scenarioDir:d},a));return f}},{key:"cleanupAgents",value:function(){logger.trace(".cleanupAgents");var a,b,c=this,d=c.agents,e=[];for(a in d)b=d[a],e.push(b.terminate());return _promise2["default"].all(e)}},{key:"destroy",value:function(){logger.trace(".destroy");var a=this;return a.destroyed=!0,a._messageQueue.length=0,a.cleanupAgents().then(function(){logger.debug("Stopping proxy."),a.proxy.stop()},function(b){logger.error("Cleanup agents failed.",b),logger.debug("Stopping proxy."),a.proxy.stop()})}},{key:"getSubjectUrl",value:function(){logger.trace(".getSubjectUrl");var a=this,b=a.callbackAddress||"127.0.0.1",c=a.scenario.getTargetUrl(),d=a.scenario.getSubjectPage();return 0==c.indexOf("http")?c:"http://"+b+":"+a.proxy.port+"/"+d}},{key:"stopTestRun",value:function(){logger.trace(".stopTestRun");var a=this;a.cleanupAgents().then(function(){a._messageQueue.length=0})["catch"](function(a){logger.error(a.stack||a)})}}],[{key:"meta",get:function(){return{prototype:{AgentClass:SandboxAgent}}}}]),b}(BaseRunner);module.exports=SandboxRunner;
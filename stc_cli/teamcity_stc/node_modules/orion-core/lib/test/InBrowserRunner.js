"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Agent=require("../model/test/Agent.js"),BaseRunner=require("./BaseRunner"),Browser=require("../model/browser/Browser"),CodeInstrumenter=require("./CodeInstrumenter"),Html=require("../Html"),LocalBrowserPool=require("../browser/LocalPool"),RemoteAgent=require("../model/test/RemoteAgent.js"),xfs=require("../xfs"),logger=require("../Logger").getInstance().forClass("test/InBrowserRunner"),InBrowserRunner=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a,b=this,c=b.proxy,d=c.getRootResponder();a=b.getInterceptablePage(),a.endsWith("index.html")&&(a=a.replace(/\/index\.html$/g,"/(index.html)?")),d.intercept("[/]?"+a+"[/]?$",b._interceptSubjectPage.bind(b)),d.intercept(".*?\\.js$",b._interceptJsFile.bind(b)),b.instrumenter=new CodeInstrumenter({scenario:b.scenario})}},{key:"getAgentContactUrl",value:function(a,b){logger.trace(".getAgentContactUrl",a,b);var c=this,d=b?"127.0.0.1":c.callbackAddress;return"http://"+d+":"+c.proxy.port+"/"+c.getAgentContactPage(a)}},{key:"getAgentContactPage",value:function(a){return logger.trace(".getAgentContactPage",a),this.parameterizePage(this.scenario.getSubjectPath(),a)}},{key:"_cacheBust",value:function(a){var b=this.cacheBuster;return a&&b&&(a+=a.indexOf("?")<0?"?":"&",a+="_dc=",a+=b===!0?this._timeStamp:b),a}},{key:"setDefaultProxyUrl",value:function(a){this.defaultProxyUrl=this.proxy.getRootResponder().defaultProxyUrl=a}},{key:"_getAdditionalLibrariesContent",value:function(){var a=this,b="",c=[],d=a.testFrameworkFiles[a.scenario.getTestFramework()];return a.orionCoreCssFiles.forEach(function(c){b+='<link rel="stylesheet" type="text/css" href="'+a._cacheBust(c)+'"/>\n'}),b+="<script>ST.runnerId="+a.id+";</script>\n",c.push.apply(c,a.orionCoreFiles),d&&c.push.apply(c,d),c.push.apply(c,a.scenario.getAdditionalLibraries("/~orion/workspace")),c.filter(function(a){return!!a}).forEach(function(c){b+='<script src="'+a._cacheBust(c)+'"></script>\n'}),b}},{key:"_getPageObjectsContent",value:function(){return this._buildFileContent(this.scenario.project.getPageObjects("/~orion/workspace"))}},{key:"_buildFileContent",value:function(a){var b=this,c="";return a.forEach(function(a){c+='<script src="'+b._cacheBust(a)+'"></script>\n'}),c}},{key:"parseInstrument",value:function(a,b,c){var d,e,f,g,h,i=Html.parse(a);if(i&&(i.forEach(function(a){h||"tag"!==a.type||"html"!==a.name||(h=a,h.children&&h.children.forEach(function(a){f||"tag"!==a.type||"head"!==a.name||(f=a)}),f||Html.appendChild(h,f={type:"tag",name:"head"}))}),f)){f.children||(f.children=[]);var j=f.children[0];f.children.forEach(function(a){"tag"===a.type&&"base"===a.name&&(j=a.next)}),d=Html.parse(c),e=Html.parse(b),Html.insertBefore(f,e,j),Html.appendChild(f,d),g=Html.stringify(i)}return g}},{key:"getInterceptablePage",value:function(){return logger.trace(".getInterceptablePage"),this.scenario.getSubjectPage()}},{key:"_interceptSubjectPage",value:function(a,b){var c,d=this,e=b.responderContext,f=e.url.query.orionChunk,g=f&&f.split("/"),h=g&&g[0],i=g&&g[1],j=d._getAdditionalLibrariesContent(),k=d._getPageObjectsContent(),l="",m="";return l='\n<script src="'+d._cacheBust("/~orion/files/init.js")+'"></script>\n'+j+"\n"+k,m+="\n<script>ST.beforeFiles();</script>\n",d._getChunkFiles(h,i).forEach(function(a){m+=d.getTestSuiteScriptTag(a)}),m+="<script>ST.afterFiles();</script>\n",(c=d.parseInstrument(a,l,m))||(c=a.replace(/<head>/,"<head>"+l),c=c.replace(/<\/head>/,m+"</head>")),c}},{key:"getTestSuiteScriptTag",value:function(a){var b,c,d=this,e=xfs.normalize(d.project.getWorkspaceMountDir()),f=xfs.normalize(d.project.resolve(d.scenario.get("directory"))),g=a.substring(e.length+1),h=a.substring(f.length+1);return c=g.replace(/\\/g,"/").split("/").map(function(a){return a.split(".").map(function(a){return encodeURIComponent(a)}).join(".")}).join("/"),c=d._cacheBust(c),c="/~orion/workspace/"+c,b='<script>ST.beforeFile("'+h+'");</script>\n<script src="'+c+'"></script>\n<script>ST.afterFile("'+h+'");</script>\n'}},{key:"_interceptJsFile",value:function(a,b){var c=this,d=c.instrumenter,e=b.responderContext,f=e.url;return c.enableCodeCoverage?d.instrument(a,f.pathname):a}},{key:"start",value:function(){var a=this,b=a.agents,c=!1,d=!1;for(var e in b)e.isSandbox?d=!0:c=!0;c&&a.startProxy()}},{key:"shouldRunTestBuild",value:function(){var a=this,b=a.scenario,c=b.project,d=c.owner,e=b.get("profile"),f=!1;return d&&(d.isApp?b.get("launch")||(f=!0):f=!0,f=f&&d.needsDevBuild&&d.needsDevBuild(e)),f}},{key:"launchLocalBrowser",value:function(a,b,c,d){logger.trace(".launchLocalBrowser <=","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a),"undefined"==typeof b?"undefined":(0,_typeof3["default"])(b),"undefined"==typeof c?"undefined":(0,_typeof3["default"])(c));var e,f,g,h,i,j,k,l,m,n=this,o=n.scenario,p=o.project,q=p.owner,r=1e3,s=a&&a.userAgent||b&&b.userAgent||c&&c.userAgent,t=s&&s.fullId,u=d&&d.skipDevBuild;if(logger.debug("Launching local browser",t),b&&(logger.debug("Agent group found, getting first available agent"),i=b.firstAgent(),i&&(logger.debug("Agent found"),e=i.lastConnectionCloseTime,f=i.lastConnectionOpenTime,e>f))){if(g=+new Date-e,!(g>r))return setTimeout(function(){n.launchLocalBrowser(a,b)},r-g),b;n.parkAgent(i),i=null}if(!i&&(logger.debug("No connected agent found, looking for parked agents"),c&&(j=c.userAgent,k=c.address,c.destroyed?b&&b.count()||a||(c=n.unparkAgent(j),c||(b=b||n._getAgentGroup({id:n._generateAgentGroupId(),browserPool:a?a.pool:j.local?LocalBrowserPool.instance:null,browser:a||null,address:k}),n._setAgentGroupUserAgent(b,j))):c=n.unparkAgent(j)),c||(logger.debug("No parked agent found"),j=b&&b.userAgent||a.userAgent,k=b&&b.address||"localhost",k&&j&&(c=n.unparkAgent(j))),c||a))if(logger.debug("Parked agent:",c&&c.userAgent.userAgent),logger.debug("Browser:",a&&a.id),h=n._generateAgentId(),b||(logger.debug("No agent group"),a&&(b=n.agentGroupsByBrowserId[a.id]),b||(b=n._getAgentGroup({id:n._generateAgentGroupId(),browserPool:a?a.pool:c.userAgent.local?LocalBrowserPool.instance:null,browser:a||null}),c&&c.userAgent&&n._setAgentGroupUserAgent(b,j))),i=n._getAgent({id:h,terminateOnFinish:n.terminateAgents,browser:a}),n.isRecording&&(i.isRecording=!0),b.add(i),c&&(b.address=i.address=c.address,b.userAgent=i.userAgent=c.userAgent),n._onAgentAdded(i),l={orionAgentId:h,orionRecording:n.isRecording},c){var v=n.getAgentContactPage(l),w=n.proxy.port;logger.debug("Redirecting parked agent to http://localhost:",w,"/",v),c.redirectTo({port:w,page:v})}else if(a){m=n.getAgentContactUrl(l,a.isLocalBrowser),logger.debug("Launching browser with url",m);var x=o.get("profile"),y=!u&&n.shouldRunTestBuild();if(q&&q.isApp&&p.get("launchAppWatch")){logger.debug("Launching app watch for profile",x);q.getBuildProfile(x);q.launch(x).then(function(){a.launch({url:m})},function(a){logger.error(a.stack||a)})}else y?(logger.debug("Running test build for profile",x),q.runTestBuild(q.cmdClient,x,!1).then(function(){a.launch({url:m})},function(a){logger.error(a.stack||a)})):(logger.debug("No app watch or test build needed for url",m),a.launch({url:m}))}return logger.trace(".launchLocalBrowser =>",b.id),b}},{key:"_createAgent",value:function(a){var b,c=this;return b=a.farm?new RemoteAgent((0,_assign2["default"])({archiver:c.archiver},a)):new Agent(a)}},{key:"parkAgent",value:function(a){var b=this,c=b.parkingLot;c&&!a.isRemoteAgent?c.park(a):a.redirectTo("about:blank"),b.removeAgent(a)}},{key:"unparkAgent",value:function(a){return this.parkingLot.unpark(a)}}],[{key:"meta",get:function(){return{prototype:{cacheBuster:!0,orionCoreFiles:["/~orion/files/logger.js","/~orion/files/debug.js","/~orion/files/setup-ext.js","/~orion/files/supports.js","/~orion/files/base.js","/~orion/files/common.js","/~orion/files/context/Base.js","/~orion/files/context/Local.js","/~orion/files/Version.js","/~orion/files/Browser.js","/~orion/files/OS.js","/~orion/files/Element.js","/~orion/files/Timer.js","/~orion/files/KeyMap.js","/~orion/files/Alert.js","/~orion/files/Url.js","/~orion/files/event/Event.js","/~orion/files/event/wgxpath.install.js","/~orion/files/Locator.js","/~orion/files/locator/Strategy.js","/~orion/files/event/Driver.js","/~orion/files/event/Event.js","/~orion/files/event/Injector.js","/~orion/files/playable/Playable.js","/~orion/files/playable/State.js","/~orion/files/event/Player.js","/~orion/files/event/Recorder.js","/~orion/files/event/GestureQueue.js","/~orion/files/future/Element.js","/~orion/files/future/Component.js","/~orion/files/pageobject/Manager.js","/~orion/files/pageobject/Base.js","/~orion/files/orion.js"],orionCoreCssFiles:["/~orion/files/base.css","/~orion/files/alert.css"],testFrameworkFiles:{jasmine:["/~orion/files/jasmine/jasmine.js","/~orion/files/jasmine-orion.js","/~orion/files/jasmine-pre-extensions.js","/~orion/files/jasmine/boot.js","/~orion/files/jasmine-post-extensions.js","/~orion/files/Expect.js"]}}}}}]),b}(BaseRunner);InBrowserRunner.parkingLot={},module.exports=InBrowserRunner;
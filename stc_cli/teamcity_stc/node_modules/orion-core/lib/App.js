"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),Path=require("path"),Shell=require("electron").shell,IpcMain=require("electron").ipcMain,Base=require("./Base"),Platform=require("./Platform"),AppSettings=require("./AppSettings"),Util=require("./Util"),fs=require("fs"),xfs=require("./xfs"),os=require("os"),App=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){var a=this;a.settings;a.quit=a.quit.bind(a),a.captureWindowBox=a.captureWindowBox.bind(a),a.platform=new Platform((0,_assign2["default"])({app:a,asar:Path.resolve(a.root,"app.asar")},a.platform)),a.settings=new AppSettings((0,_assign2["default"])({logger:a.platform,filePath:a.platform.appRoot},a.settingsConfig=a.settings)),a.license.log=a.log.bind(a),a.electron.app.on("ready",a.start.bind(a)),IpcMain.on("set-proxy-auth",function(b,c){a.proxyAuthCallback(c.username,c.password)}),a.electron.app.on("login",function(b,c,d,e,f){b.preventDefault(),e.isProxy&&(a.mainWindow.webContents.send("get-proxy-auth","yeah!"),a.proxyAuthCallback=f)})}},{key:"log",value:function(a){(this.platform||console).log(a)}},{key:"error",value:function(a){(this.platform||console).error(a)}},{key:"captureWindowBox",value:function(){var a,b=this.mainWindow;b.isMaximized()?a={maximized:!0}:(a=this.mainWindow.getBounds(),a.maximized=!1),this.windowBox=a}},{key:"quit",value:function(){console.log("===> Quitting Electron because main window has closed.\n");var a=this,b=new AppSettings((0,_assign2["default"])({logger:a.platform,filePath:a.settings.filePath},a.settingsConfig));b.set(this.windowBox),b.save(),this.electron.app.quit()}},{key:"start",value:function(){var a=this,b=/localhost/i,c=a.settings.get(),d=a.mainWindow=new a.browserWindow({icon:Path.resolve(a.indexPath,"resources","sencha.png"),x:c.x,y:c.y,width:c.width,height:c.height,minWidth:1e3,minHeight:650});c.maximized&&d.maximize(),d.on("move",a.captureWindowBox),d.on("resize",a.captureWindowBox),d.on("closed",a.quit),d.webContents.on("new-window",function(a,c){b.test(c)||(a.preventDefault(),Shell.openExternal(c))}),d.webContents.on("will-navigate",function(a){a.preventDefault()}),a.licenseCheck()}},{key:"licenseCheck",value:function(){var a=this,b="UNLICENSED",c=!1,d=a.mainWindow,e=!1;a.license.expired?(b="UNLICENSED",c=!0):b="LEGAL",a.license._licenses.forEach(function(c){return b="Trial"===c.data.type?"EVALUATION":b,a.ping(c,b)?void(e=!0):void(e=!1)}),e?d.loadURL("file://"+Path.resolve(a.indexPath,"error.html")):c?a.onTimeBomb():d.loadURL("file://"+Path.resolve(a.indexPath,"index.html"))}},{key:"onTimeBomb",value:function(){var a=this,b=a.mainWindow;b.removeListener("move",a.captureWindowBox),b.removeListener("resize",a.captureWindowBox),b.setMinimumSize(400,200),b.setSize(400,200),b.setResizable(!1),b.loadURL("file://"+Path.resolve(a.indexPath,"expired.html"))}},{key:"ping",value:function(a,b){a=a.data;var c=this.platform.appRoot,d=Path.resolve(this.indexPath,"util/utils.jar");if(this.indexPath.indexOf("app.asar")!==-1){var e=Path.resolve(os.tmpdir(),"utils/"),f=Path.resolve(e,"utils.jar");fs.existsSync(e)&&(fs.existsSync(f)&&fs.unlinkSync(f),fs.rmdirSync(e)),fs.mkdirSync(e),fs.writeFileSync(f,fs.readFileSync(d)),d=f}if(!fs.existsSync(d))return console.log("Error, exiting to welcome screen. The Sencha utils.jar is missing. path="+d),!0;1===d.indexOf(":")?(d='"'+d+'"',c='"'+c+'"'):d=d.replace(/ /g,"\\ ");var g="";null!=a&&(g=(0,_stringify2["default"])(a),g=Buffer.from(g).toString("base64"));var h="loading",i="java -jar "+d+" ";i+="-directory "+c+" ",i+="-product "+a.product.name+" ",i+="-productVersion "+this.license.appVer+" ",i+="-eventType "+b+" ",i+="-trigger "+h+" ",i+="-licenseSerialNumber "+a.id+" ",i+="-licensedTo "+a.email+" ",i+="-licenseExpiryDate "+a.expiration+" ",i+="-custom1 licenseType="+a.type+" ",i+='-validLicenseInfo "'+g+'" ',i+="-mode production ";var j=[i];return xfs.runCommands(j,function(a,b){},this),!1}}],[{key:"init",value:function(a){return this.instance=new this(a)}}]),b}(Base);module.exports=App;
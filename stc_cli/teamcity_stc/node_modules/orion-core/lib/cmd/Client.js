"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),fs=require("fs"),http=require("http"),Path=require("path"),CmdTask=require("./CmdTask"),CPTask=require("../tasks/ChildProcessTask"),Observable=require("../Observable"),TaskManager=require("../tasks/Manager"),Util=require("orion-core/lib/Util"),logger=require("../Logger").getInstance().forClass("cmd/Client"),Client=function(a){function b(a){(0,_classCallCheck3["default"])(this,b),logger.trace(".constructor");var c=(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).call(this)),d=c;return(0,_assign2["default"])(d,(0,_assign2["default"])({running:!1,path:null,port:1900,useService:!0,tasks:{},_useProcessForExec:!1,_useProcessforDispatch:!1,_ready:!1,_readyListeners:[],enableLaunch:!0,maxMemSize:1024,_handlers:{LogMessage:[{dispatch:function(a){var b=a.taskId,c=TaskManager.getTask(b);c&&c.onLogMessage(a)}}],AntEvent:[{dispatch:function(a){var b=a.taskId,c=TaskManager.getTask(b);c&&c.onAntEvent(a)}}],TaskUpdate:[{dispatch:function(a){var b=a.status,c=d._getTask(b);c&&c.update(b)}}]}},a)),c}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"getPath",value:function(){logger.trace(".getPath");var a,b=this;if(!b.path&&b.directory){var c=b.directory;c+="/sencha",":"===c.charAt(1)&&(c+=".exe"),b.path=c}return a=b.path,logger.trace(".getPath =>",a),a}},{key:"getAppScriptDir",value:function(){return this.resolvePath("ant/build/app")}},{key:"resolvePath",value:function(a){return Path.resolve(this.directory,a)}},{key:"start",value:function(a){logger.trace(".start <=",a);var b=this;a=a||b.port,b.port=a,!b.serviceTask&&b.enableLaunch&&b._launch().then(function(a){b.serviceTask=a,b.running=!0,b.internal=!0,a.on({scope:b,complete:function(){b.running=!1,b.serviceTask=null}}),b.fire("running")})["catch"](function(a){console.log("failed to start sencha cmd : "+a),b.serviceTask=null}),b._ready||(b._onReady(b._initServiceClient.bind(b)),b._detectReady())}},{key:"_launch",value:function(){logger.trace("._launch");var a=this,b=a.getPath();return new _promise2["default"](function(c,d){try{fs.access(b,fs.F_OK,function(e){if(e)d("path not found :"+a.path);else{var f=new CPTask({description:"Sencha Cmd Service",executable:b,cmdFormatted:!0,stderrLevel:"info",args:["config","-prop","cmd.service.timeout=5","then","service","start","-port",a.port],opts:{detached:!1,cwd:a.directory,env:{_JAVA_OPTIONS:"-Xmx"+a.maxMemSize+"M"}}});f.setInternal(!0),a.cmdServiceTask=f,process.on("beforeExit",function(){a._shutdown(),f.stop()}),c(f)}})}catch(e){d(e)}})}},{key:"_dispatchMessage",value:function(a){var b=this,c=a.$type,d=c.substring(c.lastIndexOf(".")+1),e=b._handlers[d]||b._handlers[c];logger.trace("._dispatchMessage <=",c),e&&e.forEach(function(b){try{b.dispatch(a)}catch(c){console.error(c)}})}},{key:"register",value:function(a){logger.trace(".register <=","[",a.size,"]");var b=this;(0,_keys2["default"])(a).forEach(function(c){var d=a[c],e=b._handlers[c]||(b._handlers[c]=[]);e.push(d)})}},{key:"_getUrl",value:function(a){return logger.trace("._getUrl <=",a),"/"+a}},{key:"_fireReady",value:function(){logger.trace("._fireReady");var a,b=this;for(b._ready=!0;a=b._readyListeners.shift();)try{a()}catch(c){console.error(c.stack||c)}}},{key:"_detectReady",value:function(){var a=this;a._ajax({url:"/",method:"GET"}).then(function(){a._detectStart=null,a._fireReady()})["catch"](function(b){var c=(new Date).getTime(),d=a._detectStart||(a._detectStart=c);c-d<3e4&&setTimeout(a._detectReady.bind(a),250)})}},{key:"_onReady",value:function(a){logger.trace("._onReady <=","undefined"==typeof a?"undefined":(0,_typeof3["default"])(a));var b=this;b._ready&&a&&a(),b._readyListeners.push(a)}},{key:"_ajax",value:function(a){var b=this;return new _promise2["default"](function(c,d){b.useService||d("Service API not enabled");try{var e,f={protocol:"http:",hostname:Util.getLocalIpAddress(),port:b.port,method:a.method,path:a.url},g=a.params;if(g){var h=f.path.indexOf("?")>-1?"&":"?";for(var i in g)f.path=f.path+h+i+"="+encodeURIComponent(g[i])}e=http.request(f,function(a){var b="";a.on("data",function(a){b+=a}),a.on("end",function(){c(b)})}),e.on("error",function(a){d(a)});var j=a.data||a.jsonData;"string"!=typeof j&&(j=(0,_stringify2["default"])(j)),j&&e.write(j),e.end()}catch(k){d(k)}})}},{key:"_poll",value:function(){logger.trace("._poll");var a=this;return a.polling=!0,a._ajax({url:a._getUrl("updates"),timeout:6e4,method:"GET"}).then(function(b){var c=JSON.parse(b),d=c.messages;a.polling=!1,a.fire("updateStart");for(var e=0;e<d.length;e++)a._dispatchMessage(d[e]);a.fire("updateDone"),a._poll()})["catch"](function(b,c){setTimeout(a._poll.bind(a),250)})}},{key:"_initServiceClient",value:function(){logger.trace("._initServiceClient");var a=this;a.useService&&!a._clientInitialized&&(a._clientInitialized=!0,a._loadTasks().then(function(){a._poll()})["catch"](function(){a._poll()}),a.updateServiceSettings({"enable.message.stream":!0}).then(function(b){a.serviceSettings=JSON.parse(b)})["catch"](function(b){a.enableTaskPolling=!0,a._loadTasks()}))}},{key:"_getTask",value:function(a){logger.trace("._getTask <="+a.description);var b=this,c=a.id||a.taskId,d=TaskManager.getTask(c);return d||(d=new CmdTask({id:c,threadId:a.threadId,status:a,cmdClient:b,description:a.description}),d.update(a)),b.tasks[d.id]=d,d}},{key:"_loadTasks",value:function(){logger.trace("._loadTasks");var a=this,b=a._getUrl("tasks/list");return new _promise2["default"](function(c,d){a._onReady(function(){a._ajax({url:b,method:"GET"}).then(function(b){for(var d=JSON.parse(b).tasks,e=[],f=0;f<d.length;f++){var g=d[f],h=g&&a._getTask(g);e.push(h),h.update(g)}a.enableTaskPolling&&setTimeout(a._loadTasks.bind(a),5e3),c(e)})["catch"](function(a){d(a)})})})}},{key:"adjustLogging",value:function(a){logger.trace(".adjustLogging <=",a);var b=this;return new _promise2["default"](function(c,d){b._onReady(function(){b._ajax({method:"POST",url:this._getUrl("logging"),jsonData:{level:{name:a}}}).then(function(a){c(a)})["catch"](function(a){d(a)})})})}},{key:"loadWorkspace",value:function(a){logger.trace(".loadWorkspace <=",a);var b=this,c=b._getUrl("workspace/load");return new _promise2["default"](function(d,e){b._onReady(function(){b._ajax({url:c,params:{directory:a},method:"GET"}).then(function(a){try{var b=JSON.parse(a);d(b)}catch(c){logger.error(a),logger.error(c.stack||c),e(c)}})["catch"](function(a){e(a)})})})}},{key:"dispatch",value:function(a,b){logger.trace(".dispatch <=","{ opts }",b);var c=this;return b=b||c.useProcessForDispatch,b?c.execProcess((0,_assign2["default"])({binary:c.path},a)):new _promise2["default"](function(b,d){c._onReady(function(){c._ajax({url:"/dispatch",method:"POST",jsonData:a}).then(function(a){var d=JSON.parse(a),e=c._getTask(d);b(e)})["catch"](function(a){d(a)})})})}},{key:"exec",value:function(a,b){logger.trace(".exec <=","opts");var c=this;return b=b||c._useProcessForExec,b?c.execProcess(a):new _promise2["default"](function(b,d){c._onReady(function(){c._ajax({url:"/exec",method:"POST",jsonData:a}).then(function(a){var d=JSON.parse(a),e=c._getTask(d);b(e)})["catch"](function(a){d(a)})})})}},{key:"execProcess",value:function(a){var b=this;return new _promise2["default"](function(c,d){try{var e,f=b.getPath(),g={};if(a.params)for(var h in a.params){var i="sencha.cmd."+h,j=a.params[h];g[i]=j}(0,_assign2["default"])(g,{_JAVA_OPTIONS:"-Xmx"+b.maxMemSize+"M"}),e=new CPTask((0,_assign2["default"])(a,{executable:a.binary||f,cmdFormatted:!0,stderrLevel:"info",opts:{detached:!1,env:g,cwd:a.cwd}})),c(e)}catch(k){d(k)}})}},{key:"stopTask",value:function(a){var b=this;return new _promise2["default"](function(c,d){b._onReady(function(){b._ajax({url:"/tasks/stop",method:"GET",params:{taskId:a.id}}).then(function(a){c(a)})["catch"](function(a){d(a)})})})}},{key:"updateServiceSettings",value:function(a){var b=this;return new _promise2["default"](function(c,d){b._onReady(function(){b._ajax({url:"/settings",method:"post",jsonData:a}).then(function(a){b.serviceSettings=JSON.parse(a),c(b.serviceSettings)})["catch"](function(a){d(a)})})})}},{key:"_shutdown",value:function(){var a=this,b=function(){a.serviceTask&&(a.serviceTask.stop(),a.serviceTask=null)};return new _promise2["default"](function(c,d){a._onReady(function(){a._ajax({url:"/shutdown",method:"GET"}).then(function(){b(),c()})["catch"](function(a){b(),d(a)})})})}}]),b}(Observable);module.exports=Client;
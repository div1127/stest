"use strict";function _interopRequireDefault(a){return a&&a.__esModule?a:{"default":a}}var _getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2),http=require("http"),Observable=require("../Observable"),Task=require("../tasks/Task"),uuid=require("uuid"),Responder=require("./Responder"),logger=require("../Logger").getInstance().forClass("web/Server"),Server=function(a){function b(){return(0,_classCallCheck3["default"])(this,b),(0,_possibleConstructorReturn3["default"])(this,(b.__proto__||(0,_getPrototypeOf2["default"])(b)).apply(this,arguments))}return(0,_inherits3["default"])(b,a),(0,_createClass3["default"])(b,[{key:"ctor",value:function(){logger.trace(".ctor");var a=this;a.sockets={},a.nextSocketId=0,a.portSeed=a.portSeed||a.defaultPortSeed}},{key:"start",value:function(){logger.trace(".start");var a=this;a.isRunning||(a.getServer(),a._listen())}},{key:"getServer",value:function(){logger.trace(".getServer");var a,b,c=this;return c.server||(b=c.getRootResponder(),a=c.server=http.createServer(b.handleRequest.bind(b)),a.timeout=0,a.on("listening",c._onListen.bind(c)),a.on("error",c._onError.bind(c)),a.on("connection",c._onConnection.bind(c))),c.server}},{key:"getRootResponder",value:function(){logger.trace(".getRootResponder");var a=this;return a._root||(a._root=new Responder),a._root}},{key:"stop",value:function(){logger.trace(".stop");var a,b,c=this,d=c.sockets;c.isRunning&&(c.server.close(function(){a||(a=!0,c.fire("closed"),c.server.removeAllListeners())}),setTimeout(function(){for(b in d)d[b].destroy()},50),c.isRunning=!1),c.done()}},{key:"_listen",value:function(){logger.trace("._listen");var a=this;a.server.listen(a.port||a.portSeed)}},{key:"_onListen",value:function(){logger.trace("._onListen");var a=this;a.port||(a.port=a.portSeed),a.info(a.description+" open on port "+a.port),a.setDescription(a.description+" @ "+a.port),a.isRunning=!0,a._set("running",!0),a.fire("running"),a.fire({type:"started",port:a.port})}},{key:"_onError",value:function(a){logger.trace("._onError");var b=this;"ECONNRESET"===a.code||("EADDRINUSE"!==a.code||b.port?(b.error((a.stack||a).toString()),b.fire({type:"error",error:a,task:{description:b.description,port:b.port}})):(b.portSeed++,b._listen()))}},{key:"_onConnection",value:function(a){logger.trace("._onConnection");var b=this.sockets,c=++this.nextSocketId;b[c]=a,a.once("close",function(){delete b[c]})}}],[{key:"meta",get:function(){return{prototype:{description:"Server",defaultPortSeed:8e3}}}}]),b}(Task);module.exports=Server;